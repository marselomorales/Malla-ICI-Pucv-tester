<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <title>Malla Interactiva ‚Äî Ingenier√≠a Inform√°tica</title>

  <!-- Iconos desde CDN -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- Fuentes de Google -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      --font-secondary: 'Inter', sans-serif;
      
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --ink-light: #1e293b;
      --ink-dark: #e2e8f0;

      --accent: #4f46e5;
      --accent-2: #10b981;
      --accent-light: #e0e7ff;
      --accent-dark: #3730a3;

      --programacion: #4f46e5;
      --matematicas: #ef4444;
      --fisica: #10b981;
      --ingenieria: #f59e0b;
      --humanidades: #f97316;
      --optativos: #8b5cf6;
      --fofu: #0ea5e9;

      --tip-max-w: 420px;
      
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --box-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
      --transition: all 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--bg-light); 
      color: var(--ink-light);
      min-height: 100vh; 
      padding: 16px; 
      transition: var(--transition);
      line-height: 1.5;
      font-size: 14px;
    }
    body.active { background: var(--bg-dark); color: var(--ink-dark); }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    
    header { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      justify-content: space-between; 
      flex-wrap: wrap; 
      margin-bottom: 20px; 
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    body.active header {
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .header-content {
      flex: 1;
      min-width: 240px;
    }
    
    h1 { 
      margin: 0; 
      font-size: 1.6rem; 
      line-height: 1.2;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.3px;
      margin-bottom: 4px;
    }
    body.active h1 {
      color: var(--accent-2);
    }
    
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      font-weight: 400;
      max-width: 600px;
    }
    body.active .subtitle {
      opacity: 0.7;
    }

    /* Toggle de tema compacto */
    .dark-mode {
      width: 52px; 
      height: 26px; 
      background: linear-gradient(145deg, #e0e0e0, #f5f5f5);
      border-radius: 999px; 
      display: flex; 
      align-items: center;
      cursor: pointer; 
      position: relative; 
      box-shadow: var(--box-shadow);
      user-select: none;
      transition: var(--transition);
    }
    body.active .dark-mode { 
      background: linear-gradient(145deg, #2c2c4e, #24243a); 
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
    }
    .dark-mode .circle {
      position: absolute; 
      top: 2px; 
      left: 2px; 
      width: 22px; 
      height: 22px; 
      border-radius: 50%;
      display: grid; 
      place-items: center; 
      overflow: hidden; 
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      transition: transform .3s ease, background-color .3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    body.active .dark-mode .circle { 
      transform: translateX(26px); 
      background: linear-gradient(145deg, #3a3a5e, #2d2d4d);
    }
    .dark-mode .circle ion-icon { 
      position: absolute; 
      width: 14px; 
      height: 14px; 
      transition: transform .3s ease; 
    }
    .dark-mode .sun { color: #f9c74f; }
    .dark-mode .moon { color: #f8f9fa; transform: translateY(-120%); }
    body.active .dark-mode .sun { transform: translateY(120%); }
    body.active .dark-mode .moon { transform: translateY(0); }

    /* Stats + progreso compactos */
    .progress-container { 
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 0 20px;
      background: rgba(255,255,255,0.8);
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .progress-container {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .stats { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .stat-item { 
      text-align:center; 
      padding: 14px; 
      border-radius: var(--border-radius); 
      background: rgba(255,255,255,0.9);
      font-weight: 600;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent);
    }
    body.active .stat-value {
      color: var(--accent-2);
    }
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    body.active .stat-item { 
      background: rgba(30, 41, 59, 0.7); 
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .progress { 
      width:100%; 
      height:20px; 
      border-radius:10px; 
      overflow:hidden; 
      position:relative; 
      background:#e0e7ff; 
      box-shadow: inset 0 0 3px rgba(0,0,0,.1); 
    }
    body.active .progress {
      background: #1e293b;
    }
    .progress-bar { 
      height:100%; 
      width:0%; 
      background: linear-gradient(90deg, var(--accent), var(--accent-2)); 
      transition: width .4s ease; 
      position: relative; 
    }
    .progress-text { 
      position:absolute; 
      inset:0; 
      display:grid; 
      place-items:center; 
      font-size:11px; 
      font-weight:700; 
      color:#fff; 
      text-shadow: 0 1px 1px rgba(0,0,0,.4); 
      pointer-events:none; 
      letter-spacing: 0.3px;
    }

    /* Leyenda compacta */
    .legend { 
      display:flex; 
      gap:10px 16px; 
      flex-wrap:wrap; 
      justify-content:center; 
      font-size:12px; 
      margin-bottom: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
      font-family: var(--font-secondary);
    }
    body.active .legend {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .legend .cuadro { 
      width:12px; 
      height:12px; 
      border-radius:3px; 
      display:inline-block; 
      vertical-align:middle; 
      margin-right:6px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lg-aprob { background:#d1fae5; } 
    .lg-disp { background:#fef3c7; } 
    .lg-bloq { background:#e2e8f0; }

    /* Controles compactos */
    .controls-container {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .controls { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      justify-content: flex-start;
    }
    .btn { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:8px 14px; 
      border:none; 
      border-radius:10px; 
      cursor:pointer; 
      background: var(--accent); 
      color:#fff; 
      font-weight:600; 
      font-size: 13px;
      font-family: var(--font-secondary);
      transition: var(--transition); 
      box-shadow: var(--box-shadow);
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
      background: var(--accent-dark);
    }
    .btn:active { 
      transform: translateY(0); 
    }
    .btn.active { 
      background: var(--accent-2); 
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn.active:hover {
      background: #0da271;
    }

    .search-container { 
      display:flex; 
      align-items:center; 
      gap:10px; 
      background: var(--card-light); 
      border-radius: var(--border-radius); 
      padding: 10px 14px; 
      box-shadow: var(--box-shadow); 
      transition: var(--transition);
      max-width: 320px;
    }
    body.active .search-container { 
      background: var(--card-dark); 
      box-shadow: 0 2px 8px rgba(0,0,0,.25); 
    }
    .search-container ion-icon { 
      opacity:.7; 
      font-size: 16px;
    }
    #search-input { 
      flex:1; 
      border:none; 
      outline:none; 
      background: transparent; 
      font-size: 13px; 
      color: inherit; 
      font-family: var(--font-secondary);
    }
    #search-input::placeholder {
      color: #888;
      font-size: 13px;
    }
    body.active #search-input::placeholder {
      color: #aaa;
    }

    .area-filter { 
      display:flex; 
      flex-wrap:wrap; 
      gap:6px; 
      margin-bottom: 16px; 
      padding: 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .area-filter {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .area-btn { 
      padding: 6px 12px; 
      border-radius: 50px; 
      border: none; 
      font-size: 12px; 
      cursor:pointer; 
      opacity: .85; 
      transition: var(--transition); 
      color:#fff; 
      font-weight: 500;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .area-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0.95;
    }
    .area-btn.active { 
      opacity: 1; 
      transform: scale(1.04); 
      box-shadow: 0 3px 8px rgba(0,0,0,.2);
      font-weight: 600;
    }
    .area-btn[data-area="all"] { 
      background: #64748b; 
    }
    .area-btn[data-area="programacion"] { background: var(--programacion); }
    .area-btn[data-area="matematicas"] { background: var(--matematicas); }
    .area-btn[data-area="fisica"] { background: var(--fisica); }
    .area-btn[data-area="ingenieria"] { background: var(--ingenieria); color:#222; }
    .area-btn[data-area="humanidades"] { background: var(--humanidades); color:#222; }
    .area-btn[data-area="optativos"] { background: var(--optativos); }
    .area-btn[data-area="fofus"] { background: var(--fofu); color:#111; }

    /* Grid compacto */
    .grid { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }
    .semestre { 
      background: var(--card-light); 
      color:inherit; 
      padding: 18px 16px; 
      border-radius:var(--border-radius); 
      box-shadow: var(--box-shadow); 
      transition: var(--transition); 
      display: flex;
      flex-direction: column;
    }
    body.active .semestre { 
      background: var(--card-dark); 
      box-shadow: 0 6px 15px rgba(0,0,0,.2); 
    }
    .semestre h3 { 
      margin: 0 0 16px 0; 
      font-size: 1.1rem; 
      opacity:.9;
      font-weight: 600;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--accent);
      text-align: center;
      position: relative;
    }
    .semestre h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }
    body.active .semestre h3 {
      color: var(--accent-2);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.active .semestre h3::after {
      background: var(--accent-2);
    }

    .ramo { 
      margin: 8px 0; 
      padding: 12px; 
      border-radius:10px; 
      cursor:pointer; 
      text-align:center; 
      font-size:13px; 
      position:relative; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      min-height:64px; 
      transition: var(--transition); 
      outline: none; 
      background: #f8fafc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      border-left: 4px solid var(--programacion);
    }
    body.active .ramo {
      background: #1e293b;
    }
    .ramo:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
    }
    .ramo:focus-visible { 
      outline: 2px solid var(--accent); 
      outline-offset: 2px; 
    }

    .ramo[data-area="programacion"] { border-left-color: var(--programacion); }
    .ramo[data-area="matematicas"] { border-left-color: var(--matematicas); }
    .ramo[data-area="fisica"] { border-left-color: var(--fisica); }
    .ramo[data-area="ingenieria"] { border-left-color: var(--ingenieria); }
    .ramo[data-area="humanidades"] { border-left-color: var(--humanidades); }
    .ramo[data-area="optativos"] { border-left-color: var(--optativos); }
    .ramo[data-area="fofus"] { border-left-color: var(--fofu); }

    .ramo .ramo-nombre { 
      font-weight:600; 
      margin-bottom:4px; 
      font-size: 14px;
    }
    .ramo .ramo-detalles { 
      display:flex; 
      justify-content:space-between; 
      font-size:12px; 
      gap:6px; 
      opacity: 0.85;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(0,0,0,0.1);
    }
    body.active .ramo .ramo-detalles {
      border-top: 1px dashed rgba(255,255,255,0.1);
    }
    .ramo .ramo-sigla { 
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .ramo .ramo-creditos { 
      font-weight:600; 
    }

    .bloqueado { 
      background:#e9ecef !important; 
      color:#6c757d !important; 
      cursor:not-allowed; 
      opacity: 0.8;
    }
    body.active .bloqueado {
      background: #1e293b !important;
      color: #94a3b8 !important;
    }
    .disponible { 
      background:#fef3c7 !important; 
      color:#000 !important; 
    }
    body.active .disponible {
      background: #1e293b !important;
    }
    .aprobado { 
      background:#d1fae5 !important; 
      color:#000 !important; 
    }
    body.active .aprobado {
      background: #0f1d15 !important;
    }

    .desbloqueado { 
      animation: fadeInScale .3s ease forwards; 
      opacity: 0; 
      transform: scale(.97); 
    }
    @keyframes fadeInScale { 
      to { 
        opacity:1; 
        transform: scale(1);
      }
    }

    .retirado { 
      animation: fadeOutScale .3s ease forwards; 
      opacity:1; 
      transform:scale(1); 
    }
    @keyframes fadeOutScale { 
      to { 
        opacity:0; 
        transform:scale(.95);
      }
    }

    /* Tooltip compacto */
    .ramo:hover::after, .ramo:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute; 
      bottom: 110%; 
      left: 50%; 
      transform: translateX(-50%);
      background: #1e293b; 
      color:#f8fafc; 
      padding: 10px 14px; 
      border-radius: 8px; 
      font-size: 12px; 
      white-space: pre-wrap; 
      opacity:.98; 
      pointer-events:none; 
      z-index:9999;
      width: min(var(--box-w, 280px), var(--tip-max-w, 380px), calc(100vw - 24px)); 
      box-sizing: border-box; 
      text-align:center; 
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      line-height: 1.4;
      font-family: var(--font-secondary);
    }

    /* Tooltip touch */
    #touch-tip { 
      position: fixed; 
      background: #1e293b; 
      color: #f8fafc; 
      font-size: 12px; 
      line-height: 1.4; 
      padding: 10px 14px; 
      border-radius: 8px; 
      box-shadow: 0 8px 20px rgba(0,0,0,.35); 
      z-index: 10000; 
      max-width: none; 
      display: none; 
      white-space: pre-wrap; 
      transform: translate(-50%, -8px); 
      pointer-events: none; 
      box-sizing: border-box; 
      text-align: center; 
      font-family: var(--font-secondary);
    }

    .ramo{
      -webkit-tap-highlight-color: transparent; 
      -webkit-touch-callout: none; 
      user-select: none; 
      touch-action: manipulation;
    }

    /* Accesibilidad oculta */
    .sr-only { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }

    /* Resaltado SOLO de prerrequisitos */
    .is-self { box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset; }
    .is-prereq { 
      outline: 2px dashed #3b82f6; 
      outline-offset: 2px; 
      z-index: 10;
    }

    /* ========== MEJORAS RESPONSIVE PARA M√ìVILES ========== */
    @media (max-width: 768px) {
      /* Ajuste general */
      body {
        padding: 10px;
      }
      
      /* Header en columna */
      header {
        flex-direction: column;
        text-align: center;
        gap: 16px;
      }
      
      .header-content {
        min-width: 100%;
      }
      
      .dark-mode {
        margin: 0 auto;
      }
      
      /* Estad√≠sticas en 2 columnas */
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      
      .stat-value {
        font-size: 1.2rem;
      }
      
      .stat-label {
        font-size: 0.8rem;
      }
      
      /* Controles en columna */
      .controls-container {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .search-container {
        max-width: 100%;
      }
      
      /* Filtros de √°rea m√°s compactos */
      .area-filter {
        justify-content: center;
        padding: 10px;
      }
      
      .area-btn {
        padding: 5px 10px;
        font-size: 11px;
      }
      
      /* Semestres en columna */
      .grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .semestre {
        padding: 15px 12px;
      }
      
      .semestre h3 {
        font-size: 1.05rem;
        margin-bottom: 14px;
      }
      
      /* Ramos m√°s compactos */
      .ramo {
        padding: 10px;
        min-height: 60px;
      }
      
      .ramo .ramo-nombre {
        font-size: 13px;
      }
      
      .ramo .ramo-detalles {
        font-size: 11px;
      }
      
      /* Footer m√°s peque√±o */
      .footer {
        font-size: 12px;
        padding: 15px 0;
        margin-top: 20px;
      }
      
      /* Mejora tooltip */
      .ramo:hover::after, .ramo:focus-visible::after {
        max-width: 90vw;
        font-size: 11px;
        padding: 8px 12px;
      }
      
      #touch-tip {
        font-size: 11px;
        max-width: 90vw;
      }
    }
    
    /* Ajustes para pantallas muy peque√±as */
    @media (max-width: 480px) {
      h1 {
        font-size: 1.4rem;
      }
      
      .subtitle {
        font-size: 0.8rem;
      }
      
      .progress-container {
        padding: 12px;
      }
      
      .legend {
        font-size: 11px;
        padding: 8px 10px;
      }
      
      .legend .cuadro {
        width: 10px;
        height: 10px;
      }
      
      .progress {
        height: 18px;
      }
      
      .progress-text {
        font-size: 10px;
      }
      
      .ramo .ramo-nombre {
        font-size: 12px;
      }
      
      .ramo .ramo-detalles {
        flex-direction: column;
        gap: 2px;
      }
    }
    
    /* Orientaci√≥n horizontal para m√≥viles */
    @media (max-width: 768px) and (orientation: landscape) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
    }
    
    /* Footer */
    .footer { 
      text-align:center; 
      padding: 20px 0; 
      margin-top: 30px; 
      font-size:13px; 
      color:#666; 
      border-top: 1px solid #e2e8f0; 
      transition: color .3s, border-color .3s; 
      font-family: var(--font-secondary);
    }
    body.active .footer { 
      color:#aaa; 
      border-top-color:#334155; 
    }
    .footer a { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      transition: color 0.2s;
    }
    body.active .footer a { 
      color: #818cf8; 
    }
    .footer a:hover { 
      text-decoration: underline; 
      color: var(--accent-dark);
    }
    
    /* Mensaje sin resultados */
    .no-results {
      text-align: center;
      padding: 30px 16px;
      font-size: 16px;
      color: #64748b;
      grid-column: 1 / -1;
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .no-results {
      background: rgba(30, 41, 59, 0.6);
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>Malla Interactiva</h1>
        <div class="subtitle">Seguimiento de progreso en Ingenier√≠a Inform√°tica</div>
      </div>
      <div class="dark-mode" id="theme-toggle" aria-label="Cambiar tema" role="switch" aria-checked="false" tabindex="0">
        <div class="circle">
          <ion-icon class="sun" name="sunny"></ion-icon>
          <ion-icon class="moon" name="moon"></ion-icon>
        </div>
      </div>
    </header>

    <div class="progress-container" aria-live="polite">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="total-ramos">0</div>
          <div class="stat-label">Total ramos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="aprobados-ramos">0</div>
          <div class="stat-label">Aprobados</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="creditos-total">0/0</div>
          <div class="stat-label">Cr√©ditos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="porcentaje">0%</div>
          <div class="stat-label">Progreso</div>
        </div>
      </div>
      <div class="progress" aria-label="Progreso total">
        <div class="progress-bar" id="barraProgreso">
          <div class="progress-text" id="textoProgreso">0%</div>
        </div>
      </div>
    </div>

    <div class="legend">
      <span><span class="cuadro lg-aprob"></span> Aprobado</span>
      <span><span class="cuadro lg-disp"></span> Disponible</span>
      <span><span class="cuadro lg-bloq"></span> Bloqueado</span>
    </div>

    <div class="area-filter" role="group" aria-label="Filtrar por √°rea">
      <button class="area-btn" data-area="all">Todos</button>
      <button class="area-btn" data-area="programacion">Programaci√≥n</button>
      <button class="area-btn" data-area="matematicas">Matem√°ticas</button>
      <button class="area-btn" data-area="fisica">F√≠sica</button>
      <button class="area-btn" data-area="ingenieria">Ingenier√≠a</button>
      <button class="area-btn" data-area="humanidades">Humanidades</button>
      <button class="area-btn" data-area="fofus">Fofus</button>
      <button class="area-btn" data-area="optativos">Optativos</button>
    </div>

    <div class="controls-container">
      <div class="controls">
        <button class="btn" id="btn-reset"><ion-icon name="refresh-outline"></ion-icon> Reiniciar</button>
        <button class="btn" id="toggle-disponibles"><ion-icon name="eye-outline"></ion-icon> Disponibles</button>
      </div>
      <div class="search-container">
        <ion-icon name="search-outline"></ion-icon>
        <input type="text" id="search-input" placeholder="Buscar por nombre o sigla‚Ä¶" aria-label="Buscar ramos">
      </div>
    </div>

    <div class="grid" id="malla" role="list"></div>
  </div>

  <div class="footer">
    Desarrollado por <a href="https://www.instagram.com/chelo_.morales" target="_blank" rel="noopener">Marcelo Morales</a>
  </div>

  <!-- Tooltip touch -->
  <div id="touch-tip" role="status" aria-live="polite"></div>

  <!-- El JavaScript permanece igual -->
  <script>
  // ========= Utilidades =========
  const normalizarTexto = (str) => (str || '').normalize('NFD').replace(/[ÃÄ-ÕØ]/g, '').toLowerCase();
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const cssVarPx = (name, fallback) => { const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim(); const n = parseFloat(v); return Number.isFinite(n) ? n : fallback; };

  // ========= Config tooltip touch =========
  const CONFIG = { tipMinW: 140, tipMaxW: null, tapMs: 140, moveHoverThrottleMs: 400, tipLongPress: false };

  // ========= Modo Oscuro =========
  const toggle = document.getElementById('theme-toggle');
  const body = document.body;
  const applyTheme = (mode) => { if (mode === 'dark') body.classList.add('active'); else body.classList.remove('active'); toggle?.setAttribute('aria-checked', mode === 'dark' ? 'true' : 'false'); };
  applyTheme(localStorage.getItem('modo') || 'light');
  const swapTheme = () => { const isDark = body.classList.toggle('active'); const modo = isDark ? 'dark' : 'light'; localStorage.setItem('modo', modo); toggle?.setAttribute('aria-checked', isDark ? 'true' : 'false'); };

  toggle?.addEventListener('click', swapTheme);
  toggle?.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); swapTheme(); } });

  // ========= Datos: 43 ramos exactos + cr√©ditos optativos corregidos =========
  const cursosRaw = [
    // Sem 1
    {sem:1, sigla:"INF1211", nombre:"Fundamentos De Algoritmos", creditos:4, area:"programacion", prereqs:[]},
    {sem:1, sigla:"INF1212", nombre:"Introducci√≥n A La Ingenier√≠a Inform√°tica", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:1, sigla:"INF1413", nombre:"Bienestar Y Aprendizaje Universitario", creditos:2, area:"humanidades", prereqs:[]},
    {sem:1, sigla:"MAT1001", nombre:"Fundamentos De Matem√°ticas Para Ingenier√≠a", creditos:6, area:"matematicas", prereqs:[]},
    // Sem 2
    {sem:2, sigla:"FIN100-14", nombre:"Desarrollo Integral Y Comunicaci√≥n Para Ingenier√≠a", creditos:3, area:"humanidades", prereqs:[]},
    {sem:2, sigla:"INF1214", nombre:"Fundamentos De Programaci√≥n", creditos:4, area:"programacion", prereqs:["INF1211"]},
    {sem:2, sigla:"MAT1002", nombre:"Calculo Diferencial E Integral", creditos:6, area:"matematicas", prereqs:["MAT1001"]},
    {sem:2, sigla:"MAT1004", nombre:"Algebra Lineal", creditos:4, area:"matematicas", prereqs:["MAT1001"]},
    {sem:2, sigla:"FF1", nombre:"Formaci√≥n Fundamental 1", creditos:2, area:"fofus", prereqs:[]},
    // Sem 3
    {sem:3, sigla:"FIS1002", nombre:"F√≠sica Para Ingenier√≠a", creditos:5, area:"fisica", prereqs:["MAT1001"]},
    {sem:3, sigla:"INF2121", nombre:"Estad√≠stica Computacional", creditos:4, area:"matematicas", prereqs:[]},
    {sem:3, sigla:"INF2223", nombre:"Estructura De Datos", creditos:4, area:"programacion", prereqs:["INF1214"]},
    {sem:3, sigla:"INF2322", nombre:"Hardware Y Sistemas Operativos", creditos:4, area:"ingenieria", prereqs:["INF1214"]},
    {sem:3, sigla:"ICR010", nombre:"Antropolog√≠a Cristiana", creditos:2, area:"fofus", prereqs:[]},
    {sem:3, sigla:"FF2", nombre:"Formaci√≥n Fundamental 2", creditos:2, area:"fofus", prereqs:[]},
    // Sem 4
    {sem:4, sigla:"INF2235", nombre:"Base De Datos", creditos:4, area:"programacion", prereqs:["INF1214"]},
    {sem:4, sigla:"INF2236", nombre:"Programaci√≥n Avanzada", creditos:4, area:"programacion", prereqs:["INF2223"]},
    {sem:4, sigla:"INF2237", nombre:"Ingenier√≠a De Software", creditos:4, area:"ingenieria", prereqs:["INF2223"]},
    {sem:4, sigla:"INF2324", nombre:"Redes De Computadores", creditos:4, area:"ingenieria", prereqs:["INF2322"]},
    {sem:4, sigla:"ING9001", nombre:"Ingles 1", creditos:2, area:"humanidades", prereqs:[]},
    {sem:4, sigla:"ICR020", nombre:"√âtica Cristiana", creditos:2, area:"fofus", prereqs:[]},
    // Sem 5
    {sem:5, sigla:"INF3132", nombre:"Econom√≠a Y Finanzas", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:5, sigla:"INF3233", nombre:"Inteligencia Artificial", creditos:4, area:"programacion", prereqs:["INF2236"]},
    {sem:5, sigla:"INF3234", nombre:"Modelamiento De Software", creditos:4, area:"ingenieria", prereqs:["INF2235"]},
    {sem:5, sigla:"INF3235", nombre:"Ingenier√≠a De Requerimientos", creditos:3, area:"ingenieria", prereqs:["INF2237"]},
    {sem:5, sigla:"ING9002", nombre:"Ingles 2", creditos:2, area:"humanidades", prereqs:["ING9001"]},
    // Sem 6
    {sem:6, sigla:"INF3136", nombre:"Optimizaci√≥n", creditos:4, area:"matematicas", prereqs:[]},
    {sem:6, sigla:"INF3245", nombre:"Ingenier√≠a Web Y M√≥vil", creditos:4, area:"programacion", prereqs:["INF3234"]},
    {sem:6, sigla:"INF3246", nombre:"Experiencia Del Usuario", creditos:3, area:"ingenieria", prereqs:["INF3235"]},
    {sem:6, sigla:"INF3541", nombre:"Taller De Base De Datos", creditos:3, area:"programacion", prereqs:["INF2235"]},
    {sem:6, sigla:"ING9003", nombre:"Ingles 3", creditos:2, area:"humanidades", prereqs:["ING9002"]},
    {sem:6, sigla:"FF3", nombre:"Formaci√≥n Fundamental 3", creditos:2, area:"fofus", prereqs:[]},
    {sem:6, sigla:"OPT1", nombre:"Optativo I", creditos:4, area:"optativos", prereqs:[]},
    // Sem 7
    {sem:7, sigla:"INF4353", nombre:"Ciberseguridad", creditos:4, area:"ingenieria", prereqs:["INF2324"]},
    {sem:7, sigla:"INF4457", nombre:"Tecnolog√≠as Emergentes", creditos:4, area:"ingenieria", prereqs:[]},
    {sem:7, sigla:"INF4552", nombre:"Taller De Ingenier√≠a De Software", creditos:4, area:"ingenieria", prereqs:["INF2237"]},
    {sem:7, sigla:"INF4556", nombre:"Seminario De Titulo", creditos:4, area:"ingenieria", prereqs:["INF3136","INF3541","INF3245","INF3246","INF3233","INF2324","INF1214","INF1212","FIS1002","MAT1004","MAT1002"]},
    {sem:7, sigla:"ING9004", nombre:"Ingles 4", creditos:2, area:"humanidades", prereqs:["ING9003"]},
    {sem:7, sigla:"OPT2", nombre:"Optativo II", creditos:4, area:"optativos", prereqs:[]},
    // Sem 8
    {sem:8, sigla:"INF4458", nombre:"Negocios, Innovaci√≥n y Emprendimiento", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:8, sigla:"INF4459", nombre:"Legislaci√≥n, √âtica y Tecnolog√≠a", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:8, sigla:"OPT3", nombre:"Optativo III", creditos:4, area:"optativos", prereqs:[]},
    {sem:8, sigla:"INF4560", nombre:"Proyecto De Titulo", creditos:10, area:"ingenieria", prereqs:["INF4556"]},
  ];

  // ========= √çndices y estructuras =========
  const siglaToNombre = new Map(cursosRaw.map(c => [c.sigla, c.nombre]));
  const ramos = {};              // nombre -> {semestre, area, sigla, abre:[]}
  const creditosRamos = {};      // nombre -> cr√©ditos
  const prereqsPorNombre = {};   // nombre -> [nombres prereq]

  for (const c of cursosRaw) {
    ramos[c.nombre] = { semestre: c.sem, area: c.area, sigla: c.sigla, abre: [] };
    creditosRamos[c.nombre] = c.creditos ?? 0;
    prereqsPorNombre[c.nombre] = (c.prereqs || []).map(sig => siglaToNombre.get(sig)).filter(Boolean);
  }
  for (const [nombre, lista] of Object.entries(prereqsPorNombre)) {
    for (const p of lista) if (ramos[p]) ramos[p].abre.push(nombre);
  }

  const porSemestre = {};
  for (const [nombre, info] of Object.entries(ramos)) {
    if (!porSemestre[info.semestre]) porSemestre[info.semestre] = [];
    porSemestre[info.semestre].push(nombre);
  }
  const maxSemestre = Math.max(...Object.values(ramos).map(r => r.semestre));

  // ========= Persistencia por SIGLA + Firma malla =========
  const firmaMalla = JSON.stringify(cursosRaw.map(c => c.sigla).sort());
  const firmaGuardada = localStorage.getItem('firma_malla');
  if (firmaGuardada && firmaGuardada !== firmaMalla) {
    localStorage.removeItem('ramos_aprobados_siglas');
  }
  localStorage.setItem('firma_malla', firmaMalla);

  let aprobadasSiglas = JSON.parse(localStorage.getItem('ramos_aprobados_siglas') || '[]');
  const setSiglasValidas = new Set(cursosRaw.map(c => c.sigla));
  aprobadasSiglas = aprobadasSiglas.filter(s => setSiglasValidas.has(s));
  localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));

  const aprobadosNombres = () => aprobadasSiglas.map(s => siglaToNombre.get(s)).filter(Boolean);
  const aprobadoPorNombre = new Set(aprobadosNombres());

  // ========= L√≥gica =========
  const malla = document.getElementById('malla');
  const nombreToEl = new Map();
  const estadoAnterior = new Map();
  let areaSeleccionada = 'all';
  let busqueda = '';
  let mostrarSoloDisponibles = false;

  const calcularCreditos = () => {
    let total = 0, completados = 0;
    for (const [nombre] of Object.entries(ramos)) {
      const c = creditosRamos[nombre] ?? 0; total += c; if (aprobadoPorNombre.has(nombre)) completados += c;
    }
    const porcentaje = total > 0 ? Math.round((completados / total) * 100) : 0;
    return { total, completados, porcentaje };
  };

  const prerequisitosDe = (nombre) => [...(prereqsPorNombre[nombre] || [])];
  const obtenerTodosDependientes = (nombre) => { const out = new Set(); const dfs = (n) => { for (const d of (ramos[n]?.abre || [])) if (!out.has(d)) { out.add(d); dfs(d); } }; dfs(nombre); return [...out]; };
  const estaDisponible = (nombre) => prerequisitosDe(nombre).every(p => aprobadoPorNombre.has(p));

  const aprobar = (ramoNombre) => {
    const sigla = ramos[ramoNombre]?.sigla; if (!sigla) return;
    if (aprobadoPorNombre.has(ramoNombre)) {
      const dep = obtenerTodosDependientes(ramoNombre);
      const aEliminar = [ramoNombre, ...dep];
      $$('.ramo').forEach(el => { const n = el.querySelector('.ramo-nombre')?.textContent; if (n && aEliminar.includes(n)) el.classList.add('retirado'); });
      const depSiglas = aEliminar.map(n => ramos[n]?.sigla).filter(Boolean);
      aprobadasSiglas = aprobadasSiglas.filter(s => !depSiglas.includes(s));
      localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));
      aprobadoPorNombre.clear(); aprobadosNombres().forEach(n => aprobadoPorNombre.add(n));
      render();
    } else {
      if (estaDisponible(ramoNombre)) {
        if (!aprobadasSiglas.includes(sigla)) aprobadasSiglas.push(sigla);
        localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));
        aprobadoPorNombre.add(ramoNombre);
        render();
      } else {
        alert('No puedes aprobar este ramo hasta completar sus prerrequisitos');
      }
    }
  };

  const resetear = () => { if (confirm('¬øEst√°s seguro de reiniciar todo el progreso?')) { localStorage.removeItem('ramos_aprobados_siglas'); aprobadasSiglas = []; aprobadoPorNombre.clear(); render(); } };

  // ======== Render ========
  const syncBoxWidths = () => { $$('.ramo').forEach(el => { const w = Math.round(el.getBoundingClientRect().width); el.style.setProperty('--box-w', w + 'px'); }); };

  const highlightPrereqs = (nombre, on) => { const selfEl = nombreToEl.get(nombre); if (selfEl) selfEl.classList.toggle('is-self', on); for (const p of (prereqsPorNombre[nombre] || [])) { nombreToEl.get(p)?.classList.toggle('is-prereq', on); } };

  const render = () => {
    const totalRamos = Object.keys(ramos).length;
    const aprobadosList = aprobadosNombres();
    const { total: creditosTotal, completados: creditosAprobados, porcentaje } = calcularCreditos();

    $('#total-ramos').textContent = totalRamos;
    $('#aprobados-ramos').textContent = aprobadosList.length;
    $('#creditos-total').textContent = `${creditosAprobados}/${creditosTotal}`;
    $('#porcentaje').textContent = `${porcentaje}%`;
    $('#barraProgreso').style.width = porcentaje + '%';
    $('#textoProgreso').textContent = porcentaje + '%';

    const frag = document.createDocumentFragment();
    let semestresRenderizados = 0; const nuevoEstado = new Map(); nombreToEl.clear();

    for (let sem = 1; sem <= maxSemestre; sem++) {
      const ramosSem = (porSemestre[sem] || []).filter(ramo => {
        if (areaSeleccionada !== 'all' && areaSeleccionada !== 'none') {
          if (ramos[ramo].area !== areaSeleccionada) return false;
        }
        if (busqueda) {
          const b = normalizarTexto(busqueda); const n = normalizarTexto(ramo); const s = normalizarTexto(ramos[ramo].sigla || '');
          if (!n.includes(b) && !s.includes(b)) return false;
        }
        if (mostrarSoloDisponibles) {
          if (!aprobadoPorNombre.has(ramo) && !estaDisponible(ramo)) return false;
        }
        return true;
      });

      if (!ramosSem.length) continue;

      const cont = document.createElement('div'); cont.className = 'semestre';
      const title = document.createElement('h3'); title.textContent = `${sem}¬∞ Semestre`; cont.appendChild(title);

      const innerFrag = document.createDocumentFragment();

      ramosSem.forEach(ramo => {
        const info = ramos[ramo];
        const div = document.createElement('div');
        div.className = 'ramo';
        div.dataset.area = info.area; div.dataset.creditos = creditosRamos[ramo] ?? ''; div.setAttribute('role', 'listitem'); div.tabIndex = 0;

        const contenido = document.createElement('div');
        const nombreEl = document.createElement('div'); nombreEl.className = 'ramo-nombre'; nombreEl.textContent = ramo; contenido.appendChild(nombreEl);

        const detalles = document.createElement('div'); detalles.className = 'ramo-detalles';
        const siglaEl = document.createElement('span'); siglaEl.className = 'ramo-sigla'; siglaEl.textContent = info.sigla || 'SIGLA';
        const creditos = creditosRamos[ramo];
        const creditosEl = document.createElement('span'); creditosEl.className = 'ramo-creditos'; creditosEl.textContent = `${creditos} cr√©ditos`;
        detalles.appendChild(siglaEl); detalles.appendChild(creditosEl);
        contenido.appendChild(detalles);
        div.appendChild(contenido);

        const prere = prerequisitosDe(ramo);
        const desbloqueado = prere.every(p => aprobadoPorNombre.has(p));
        const estadoKey = `${sem}:${ramo}`; nuevoEstado.set(estadoKey, desbloqueado);

        const setTooltip = (txt) => { div.setAttribute('data-tooltip', txt); };

        if (aprobadoPorNombre.has(ramo)) {
          div.classList.add('aprobado');
          setTooltip(`üü¢ Aprobado
Toca para desmarcar ‚ùå`);
          div.onclick = () => aprobar(ramo);
          div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); aprobar(ramo); } };
        } else if (estaDisponible(ramo)) {
          div.classList.add('disponible');
          if (!estadoAnterior.get(estadoKey)) { div.classList.add('desbloqueado'); void div.offsetWidth; }
          setTooltip(`üü° Disponible
Toca para aprobar ‚úÖ`);
          div.onclick = () => aprobar(ramo);
          div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); aprobar(ramo); } };
        } else {
          div.classList.add('bloqueado');
          const faltantes = prere.filter(p => !aprobadoPorNombre.has(p));
          setTooltip(`üîí Bloqueado
Requiere: ${faltantes.join(', ') || 'Ninguno'}`);
        }

        // Resaltado solo de PRERREQUISITOS
        div.addEventListener('mouseenter', () => highlightPrereqs(ramo, true));
        div.addEventListener('mouseleave', () => highlightPrereqs(ramo, false));
        div.addEventListener('focus', () => highlightPrereqs(ramo, true));
        div.addEventListener('blur', () => highlightPrereqs(ramo, false));
        nombreToEl.set(ramo, div);

        innerFrag.appendChild(div);
      });

      cont.appendChild(innerFrag);
      frag.appendChild(cont);
      semestresRenderizados++;
    }

    malla.innerHTML = '';
    malla.appendChild(frag);

    if (semestresRenderizados === 0) {
      const noResults = document.createElement('div'); 
      noResults.className = 'no-results'; 
      noResults.innerHTML = `<ion-icon name="search-outline" style="font-size: 32px; margin-bottom: 8px;"></ion-icon><br>No se encontraron ramos que coincidan con la b√∫squeda`;
      malla.appendChild(noResults);
    }

    estadoAnterior.clear(); nuevoEstado.forEach((v,k) => estadoAnterior.set(k, v));

    requestAnimationFrame(syncBoxWidths);
    setupTouchTooltips();
  };

  // ========= Tooltips touch =========
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const tip = document.getElementById('touch-tip');
  let pressTimer = null; let pressTarget = null; let startX = 0, startY = 0; const MOVE_TOL = 12; const LONG_MS = 500; let touchStartAt = 0;

  function showTipFor(target) {
    const txt = target.getAttribute('data-tooltip'); if (!txt) return;
    const boxW = target.getBoundingClientRect().width;
    const maxFromCss = cssVarPx('--tip-max-w', 420);
    const maxPx = (CONFIG.tipMaxW ?? maxFromCss) || 420;
    const vwClamp = Math.max(0, window.innerWidth - 24);
    let w = Math.min(boxW, maxPx, vwClamp); w = Math.max(CONFIG.tipMinW, w);
    tip.style.width = Math.round(w) + 'px';
    tip.textContent = txt; tip.style.display = 'block';
    positionTip(target);
    clearTimeout(tip._hideT); tip._hideT = setTimeout(hideTip, 2500);
  }
  function hideTip() { tip.style.display = 'none'; tip.textContent = ''; tip.style.width = 'auto'; }
  function positionTip(target) { const rect = target.getBoundingClientRect(); const tipRect = tip.getBoundingClientRect(); let x = rect.left + rect.width/2; let y = rect.top - 8; if (rect.top - tipRect.height - 16 < 0) { y = rect.bottom + tipRect.height/2 + 8; tip.style.transform = 'translate(-50%, -8px)'; } else { tip.style.transform = 'translate(-50%, -8px)'; } tip.style.left = x + 'px'; tip.style.top = y + 'px'; }
  function clearPress() { clearTimeout(pressTimer); pressTimer = null; pressTarget = null; }
  function onTouchStart(e){ touchStartAt = Date.now(); const t = e.target.closest('.ramo'); if (!t) return; pressTarget = t; const touch = e.changedTouches[0]; startX = touch.clientX; startY = touch.clientY; clearPress(); if (CONFIG.tipLongPress) { pressTimer = setTimeout(() => { showTipFor(t); }, LONG_MS); } }
  function onTouchMove(e) { if (!pressTimer) return; const touch = e.changedTouches[0]; if (Math.abs(touch.clientX - startX) > MOVE_TOL || Math.abs(touch.clientY - startY) > MOVE_TOL) { clearPress(); } }
  function onTouchEnd(){ clearPress(); }
  function onScrollOrOutsideTouch() { hideTip(); }
  function setupTouchTooltips() {
    if (!isTouch) return;
    document.removeEventListener('touchstart', onTouchStart, {passive:true});
    document.removeEventListener('touchmove', onTouchMove, {passive:true});
    document.removeEventListener('touchend', onTouchEnd, {passive:true});
    document.removeEventListener('scroll', onScrollOrOutsideTouch, true);
    document.addEventListener('touchstart', onTouchStart, {passive:true});
    document.addEventListener('touchmove', onTouchMove, {passive:true});
    document.addEventListener('touchend', onTouchEnd, {passive:true});
    document.addEventListener('scroll', onScrollOrOutsideTouch, true);
  }

  // ========= Listeners =========
  $$('.area-btn').forEach(btn => { btn.addEventListener('click', () => { if (btn.classList.contains('active') && btn.dataset.area === areaSeleccionada) { btn.classList.remove('active'); areaSeleccionada = 'none'; } else { $$('.area-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); areaSeleccionada = btn.dataset.area; } render(); }); });
  let debounceTimer = null; document.getElementById('search-input').addEventListener('input', (e) => { clearTimeout(debounceTimer); const v = e.target.value; debounceTimer = setTimeout(() => { busqueda = v; render(); }, 120); });
  $('#toggle-disponibles').addEventListener('click', () => { mostrarSoloDisponibles = !mostrarSoloDisponibles; const boton = $('#toggle-disponibles'); if (mostrarSoloDisponibles) { boton.classList.add('active'); boton.innerHTML = '<ion-icon name="eye-off-outline"></ion-icon> Mostrar Todos'; } else { boton.classList.remove('active'); boton.innerHTML = '<ion-icon name="eye-outline"></ion-icon> Solo Disponibles'; } render(); });
  $('#btn-reset').addEventListener('click', resetear);

  // Primera pinta
  render();


  // === Mejora: navegaci√≥n con flechas + anti-sticky-focus para ramos ===
  (function(){
    const isVisible = (el) => !!(el.offsetParent);
    const $ramos = () => Array.from(document.querySelectorAll('.ramo')).filter(isVisible);

    // Utilidad: centro del bounding box
    const center = (el) => {
      const r = el.getBoundingClientRect();
      return {x: r.left + r.width/2, y: r.top + r.height/2};
    };

    // Elegir el mejor candidato en una direcci√≥n
    function pickInDirection(from, dir){
      const origin = center(from);
      const candidates = $ramos().filter(el => !el.classList.contains('bloqueado') && el!==from);
      if (!candidates.length) return null;

      // Ponderaciones por direcci√≥n
      const weight = (dx,dy) => {
        if (dir==='ArrowRight' && dx>0) return dx*dx + (dy*dy)*0.7;
        if (dir==='ArrowLeft'  && dx<0) return dx*dx + (dy*dy)*0.7;
        if (dir==='ArrowDown'  && dy>0) return (dy*dy) + (dx*dx)*0.7;
        if (dir==='ArrowUp'    && dy<0) return (dy*dy) + (dx*dx)*0.7;
        return Infinity;
      };

      let best = null, bestScore = Infinity;
      for (const el of candidates){
        const c = center(el);
        const dx = c.x - origin.x, dy = c.y - origin.y;
        const score = weight(dx,dy);
        if (score < bestScore){ bestScore = score; best = el; }
      }
      return isFinite(bestScore) ? best : null;
    }

    // Al enfocar, saltar ramos bloqueados (anti-sticky-focus)
    document.addEventListener('focusin', (ev) => {
      const el = ev.target;
      if (!(el instanceof HTMLElement)) return;
      if (!el.classList?.contains('ramo')) return;
      if (!el.classList.contains('bloqueado')) return;

      // Buscar el vecino "m√°s cercano" desbloqueado
      const next = pickInDirection(el, 'ArrowRight')
                || pickInDirection(el, 'ArrowDown')
                || pickInDirection(el, 'ArrowLeft')
                || pickInDirection(el, 'ArrowUp');

      if (next){ 
        // Evita bucle de enfoque
        setTimeout(() => next.focus(), 0);
      }
    });

    // Navegaci√≥n con flechas + Enter/Espacio = click
    document.addEventListener('keydown', (ev) => {
      const { key } = ev;
      const active = document.activeElement;
      const dentroDeRamo = active?.classList?.contains('ramo');

      if ((key === 'Enter' || key === ' ') && dentroDeRamo){
        ev.preventDefault();
        active.click?.();
        return;
      }

      if (!['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(key)) return;
      if (!dentroDeRamo){
        // Si no est√°s en un ramo, enfoca el primero disponible
        const primero = $ramos().find(el => !el.classList.contains('bloqueado'));
        if (primero){ primero.focus(); ev.preventDefault(); }
        return;
      }

      const next = pickInDirection(active, key);
      if (next){
        next.focus();
        ev.preventDefault();
      }
    });

    // Asegurar roles/aria por accesibilidad
    (function ensureListRoles(){
      const columnas = document.querySelectorAll('.semestre');
      columnas.forEach(col => { if(!col.getAttribute('role')) col.setAttribute('role','list'); });
      $ramos().forEach(el => {
        if(!el.getAttribute('role')) el.setAttribute('role','listitem');
        if(!el.hasAttribute('tabindex')) el.tabIndex = 0;
      });
    })();
  })();

  </script>
</body>
</html>
