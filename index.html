<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <title>IngenierÃ­a Civil en InformÃ¡tica</title>

  <!-- Iconos desde CDN -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- Fuentes de Google -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      --font-secondary: 'Inter', sans-serif;
      
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --ink-light: #1e293b;
      --ink-dark: #e2e8f0;

      --accent: #4f46e5;
      --accent-2: #10b981;
      --accent-light: #e0e7ff;
      --accent-dark: #3730a3;

      --programacion: #4f46e5;
      --matematicas: #ef4444;
      --fisica: #10b981;
      --ingenieria: #f59e0b;
      --humanidades: #f97316;
      --optativos: #8b5cf6;
      --fofu: #0ea5e9;

      --tip-max-w: 420px;
      
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --box-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
      --transition: all 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--bg-light); 
      color: var(--ink-light);
      min-height: 100vh; 
      padding: 16px; 
      transition: var(--transition);
      line-height: 1.5;
      font-size: 14px;
    }
    body.active { background: var(--bg-dark); color: var(--ink-dark); }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    
    header { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      justify-content: space-between; 
      flex-wrap: wrap; 
      margin-bottom: 20px; 
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    body.active header {
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .header-content {
      flex: 1;
      min-width: 240px;
    }
    
    h1 { 
      margin: 0; 
      font-size: 1.6rem; 
      line-height: 1.2;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.3px;
      margin-bottom: 4px;
    }
    body.active h1 {
      color: var(--accent-2);
    }
    
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      font-weight: 400;
      max-width: 600px;
    }
    body.active .subtitle {
      opacity: 0.7;
    }

    /* NUEVO: Selector de semestre */
    .semestre-selector-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255,255,255,0.8);
      padding: 12px 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
      margin-bottom: 16px;
      font-family: var(--font-secondary);
    }
    body.active .semestre-selector-container {
      background: rgba(30, 41, 59, 0.6);
    }
    .semestre-selector-label {
      font-weight: 500;
      font-size: 13px;
      white-space: nowrap;
    }
    .semestre-selector {
      padding: 6px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 13px;
      font-family: var(--font-secondary);
      cursor: pointer;
      transition: var(--transition);
    }
    body.active .semestre-selector {
      background: #1e293b;
      border-color: #475569;
      color: var(--ink-dark);
    }
    .semestre-selector:focus {
      outline: none;
      border-color: var(--accent);
    }
    .semestre-info {
      font-size: 12px;
      opacity: 0.8;
      margin-left: auto;
    }

    /* Toggle de tema compacto */
    .dark-mode {
      width: 52px; 
      height: 26px; 
      background: linear-gradient(145deg, #e0e0e0, #f5f5f5);
      border-radius: 999px; 
      display: flex; 
      align-items: center;
      cursor: pointer; 
      position: relative; 
      box-shadow: var(--box-shadow);
      user-select: none;
      transition: var(--transition);
    }
    body.active .dark-mode { 
      background: linear-gradient(145deg, #2c2c4e, #24243a); 
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
    }
    .dark-mode .circle {
      position: absolute; 
      top: 2px; 
      left: 2px; 
      width: 22px; 
      height: 22px; 
      border-radius: 50%;
      display: grid; 
      place-items: center; 
      overflow: hidden; 
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      transition: transform .3s ease, background-color .3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    body.active .dark-mode .circle { 
      transform: translateX(26px); 
      background: linear-gradient(145deg, #3a3a5e, #2d2d4d);
    }
    .dark-mode .circle ion-icon { 
      position: absolute; 
      width: 14px; 
      height: 14px; 
      transition: transform .3s ease; 
    }
    .dark-mode .sun { color: #f9c74f; }
    .dark-mode .moon { color: #f8f9fa; transform: translateY(-120%); }
    body.active .dark-mode .sun { transform: translateY(120%); }
    body.active .dark-mode .moon { transform: translateY(0); }

    /* Stats + progreso compactos */
    .progress-container { 
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 0 20px;
      background: rgba(255,255,255,0.8);
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .progress-container {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .stats { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .stat-item { 
      text-align:center; 
      padding: 14px; 
      border-radius: var(--border-radius); 
      background: rgba(255,255,255,0.9);
      font-weight: 600;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent);
    }
    body.active .stat-value {
      color: var(--accent-2);
    }
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    body.active .stat-item { 
      background: rgba(30, 41, 59, 0.7); 
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .progress { 
      width:100%; 
      height:20px; 
      border-radius:10px; 
      overflow:hidden; 
      position:relative; 
      background:#e0e7ff; 
      box-shadow: inset 0 0 3px rgba(0,0,0,.1); 
    }
    body.active .progress {
      background: #1e293b;
    }
    .progress-bar { 
      height:100%; 
      width:0%; 
      background: linear-gradient(90deg, var(--accent), var(--accent-2)); 
      transition: width .4s ease; 
      position: relative; 
    }
    .progress-text { 
      position:absolute; 
      inset:0; 
      display:grid; 
      place-items:center; 
      font-size:11px; 
      font-weight:700; 
      color:#fff; 
      text-shadow: 0 1px 1px rgba(0,0,0,.4); 
      pointer-events:none; 
      letter-spacing: 0.3px;
    }

    /* Panel de AnÃ¡lisis de Atraso */
    .atraso-container {
      background: var(--card-light);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #f59e0b;
    }
    body.active .atraso-container {
      background: var(--card-dark);
    }
    .atraso-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    body.active .atraso-header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .atraso-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--accent);
    }
    .metricas-atraso {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .metrica-item {
      text-align: center;
      padding: 12px;
      background: rgba(255,255,255,0.5);
      border-radius: 8px;
    }
    body.active .metrica-item {
      background: rgba(30,41,59,0.3);
    }
    .metrica-valor {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .metrica-valor.critico {
      color: #ef4444;
    }
    .metrica-valor.advertencia {
      color: #f59e0b;
    }
    .metrica-valor.normal {
      color: #10b981;
    }
    .recomendacion-item {
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
      border-left: 3px solid #4f46e5;
    }
    body.active .recomendacion-item {
      background: rgba(30,41,59,0.4);
    }
    .recomendacion-item.alta {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }
    body.active .recomendacion-item.alta {
      background: rgba(239, 68, 68, 0.1);
    }
    .recomendacion-item.media {
      border-left-color: #f59e0b;
    }
    .recomendacion-titulo {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .recomendacion-acciones {
      font-size: 0.9rem;
    }
    .recomendacion-acciones ul {
      margin: 0;
      padding-left: 18px;
    }
    .recomendacion-acciones li {
      margin-bottom: 4px;
    }
    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
    }

    /* Leyenda compacta */
    .legend { 
      display:flex; 
      gap:10px 16px; 
      flex-wrap:wrap; 
      justify-content:center; 
      font-size:12px; 
      margin-bottom: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
      font-family: var(--font-secondary);
    }
    body.active .legend {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .legend .cuadro { 
      width:12px; 
      height:12px; 
      border-radius:3px; 
      display:inline-block; 
      vertical-align:middle; 
      margin-right:6px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lg-aprob { background:#d1fae5; } 
    .lg-disp { background:#fef3c7; } 
    .lg-bloq { background:#e2e8f0; }

    /* Controles compactos */
    .controls-container {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .controls { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      justify-content: flex-start;
    }
    .btn { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:8px 14px; 
      border:none; 
      border-radius:10px; 
      cursor:pointer; 
      background: var(--accent); 
      color:#fff; 
      font-weight:600; 
      font-size: 13px;
      font-family: var(--font-secondary);
      transition: var(--transition); 
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
      background: var(--accent-dark);
    }
    .btn:active { 
      transform: translateY(0); 
    }
    .btn.active { 
      background: var(--accent-2); 
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn.active:hover {
      background: #0da271;
    }
    /* Efecto ripple */
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    .btn:active::after {
      width: 100px;
      height: 100px;
    }

    .search-container { 
      display:flex; 
      align-items:center; 
      gap:10px; 
      background: var(--card-light); 
      border-radius: var(--border-radius); 
      padding: 10px 14px; 
      box-shadow: var(--box-shadow); 
      transition: var(--transition);
      max-width: 320px;
    }
    body.active .search-container { 
      background: var(--card-dark); 
      box-shadow: 0 2px 8px rgba(0,0,0,.25); 
    }
    .search-container ion-icon { 
      opacity:.7; 
      font-size: 16px;
    }
    #search-input { 
      flex:1; 
      border:none; 
      outline:none; 
      background: transparent; 
      font-size: 13px; 
      color: inherit; 
      font-family: var(--font-secondary);
    }
    #search-input::placeholder {
      color: #888;
      font-size: 13px;
    }
    body.active #search-input::placeholder {
      color: #aaa;
    }

    .area-filter { 
      display:flex; 
      flex-wrap:wrap; 
      gap:6px; 
      margin-bottom: 16px; 
      padding: 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .area-filter {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .area-btn { 
      padding: 6px 12px; 
      border-radius: 50px; 
      border: none; 
      font-size: 12px; 
      cursor:pointer; 
      opacity: .85; 
      transition: var(--transition); 
      color:#fff; 
      font-weight: 500;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .area-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0.95;
    }
    .area-btn.active { 
      opacity: 1; 
      transform: scale(1.04); 
      box-shadow: 0 3px 8px rgba(0,0,0,.2);
      font-weight: 600;
    }
    .area-btn[data-area="all"] { 
      background: #64748b; 
    }
    .area-btn[data-area="programacion"] { background: var(--programacion); }
    .area-btn[data-area="matematicas"] { background: var(--matematicas); }
    .area-btn[data-area="fisica"] { background: var(--fisica); }
    .area-btn[data-area="ingenieria"] { background: var(--ingenieria); color:#222; }
    .area-btn[data-area="humanidades"] { background: var(--humanidades); color:#222; }
    .area-btn[data-area="optativos"] { background: var(--optativos); }
    .area-btn[data-area="fofus"] { background: var(--fofu); color:#111; }

    /* Grid compacto */
    .grid { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }
    .semestre { 
      background: var(--card-light); 
      color:inherit; 
      padding: 18px 16px; 
      border-radius:var(--border-radius); 
      box-shadow: var(--box-shadow); 
      transition: var(--transition); 
      display: flex;
      flex-direction: column;
    }
    body.active .semestre { 
      background: var(--card-dark); 
      box-shadow: 0 6px 15px rgba(0,0,0,.2); 
    }
    .semestre h3 { 
      margin: 0 0 16px 0; 
      font-size: 1.1rem; 
      opacity:.9;
      font-weight: 600;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--accent);
      text-align: center;
      position: relative;
    }
    .semestre h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }
    body.active .semestre h3 {
      color: var(--accent-2);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.active .semestre h3::after {
      background: var(--accent-2);
    }

    .ramo { 
      margin: 8px 0; 
      padding: 12px; 
      border-radius:10px; 
      cursor:pointer; 
      text-align:center; 
      font-size:13px; 
      position:relative; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      min-height:64px; 
      transition: var(--transition); 
      outline: none; 
      background: #f8fafc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      border-left: 4px solid var(--programacion);
    }
    body.active .ramo {
      background: #1e293b;
    }
    .ramo:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
    }
    .ramo:focus-visible { 
      outline: 2px solid var(--accent); 
      outline-offset: 2px; 
    }

    .ramo[data-area="programacion"] { border-left-color: var(--programacion); }
    .ramo[data-area="matematicas"] { border-left-color: var(--matematicas); }
    .ramo[data-area="fisica"] { border-left-color: var(--fisica); }
    .ramo[data-area="ingenieria"] { border-left-color: var(--ingenieria); }
    .ramo[data-area="humanidades"] { border-left-color: var(--humanidades); }
    .ramo[data-area="optativos"] { border-left-color: var(--optativos); }
    .ramo[data-area="fofus"] { border-left-color: var(--fofu); }

    .ramo .ramo-nombre { 
      font-weight:600; 
      margin-bottom:4px; 
      font-size: 14px;
    }
    .ramo .ramo-detalles { 
      display:flex; 
      justify-content:space-between; 
      font-size:12px; 
      gap:6px; 
      opacity: 0.85;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(0,0,0,0.1);
    }
    body.active .ramo .ramo-detalles {
      border-top: 1px dashed rgba(255,255,255,0.1);
    }
    .ramo .ramo-sigla { 
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .ramo .ramo-creditos { 
      font-weight:600; 
    }

    .bloqueado { 
      background:#e9ecef !important; 
      color:#6c757d !important; 
      cursor:not-allowed; 
      opacity: 0.8;
    }
    body.active .bloqueado {
      background: #1e293b !important;
      color: #94a3b8 !important;
    }
    .disponible { 
      background:#fef3c7 !important; 
      color:#000 !important; 
    }
    body.active .disponible {
      background: #1e293b !important;
    }
    .aprobado { 
      background:#d1fae5 !important; 
      color:#000 !important; 
    }
    body.active .aprobado {
      background: #0f1d15 !important;
    }

    .desbloqueado { 
      animation: fadeInScale .3s ease forwards; 
      opacity: 0; 
      transform: scale(.97); 
    }
    @keyframes fadeInScale { 
      to { 
        opacity:1; 
        transform: scale(1);
      }
    }

    .retirado { 
      animation: fadeOutScale .3s ease forwards; 
      opacity:1; 
      transform:scale(1); 
    }
    @keyframes fadeOutScale { 
      to { 
        opacity:0; 
        transform:scale(.95);
      }
    }

    /* Tooltip mejorado */
    .ramo:hover::after, .ramo:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute; 
      bottom: 110%; 
      left: 50%; 
      transform: translateX(-50%);
      background: #1e293b; 
      color:#f8fafc; 
      padding: 12px 16px; 
      border-radius: 8px; 
      font-size: 12px; 
      white-space: pre-wrap; 
      opacity:.98; 
      pointer-events:none; 
      z-index:9999;
      width: min(var(--box-w, 280px), var(--tip-max-w, 380px), calc(100vw - 24px)); 
      box-sizing: border-box; 
      text-align:center; 
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      line-height: 1.4;
      font-family: var(--font-secondary);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Tooltip touch */
    #touch-tip { 
      position: fixed; 
      background: #1e293b; 
      color: #f8fafc; 
      font-size: 12px; 
      line-height: 1.4; 
      padding: 10px 14px; 
      border-radius: 8px; 
      box-shadow: 0 8px 20px rgba(0,0,0,.35); 
      z-index: 10000; 
      max-width: none; 
      display: none; 
      white-space: pre-wrap; 
      transform: translate(-50%, -8px); 
      pointer-events: none; 
      box-sizing: border-box; 
      text-align: center; 
      font-family: var(--font-secondary);
    }

    .ramo{
      -webkit-tap-highlight-color: transparent; 
      -webkit-touch-callout: none; 
      user-select: none; 
      touch-action: manipulation;
    }

    /* Accesibilidad oculta */
    .sr-only { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }

    /* Resaltado SOLO de prerrequisitos */
    .is-self { box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset; }
    .is-prereq { 
      outline: 2px dashed #3b82f6; 
      outline-offset: 2px; 
      z-index: 10;
    }

    /* ========= TOASTS Y CONFETI ========= */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-light);
      color: var(--ink-light);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideInUp 0.3s ease;
    }
    body.active .toast {
      background: var(--card-dark);
      color: var(--ink-dark);
    }
    @keyframes slideInUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .toast.success {
      border-left: 4px solid var(--accent-2);
    }
    .toast.info {
      border-left: 4px solid var(--accent);
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent);
      opacity: 0;
      z-index: 9999;
      pointer-events: none;
    }

    /* Loading indicator */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .controls-container {
        grid-template-columns: 1fr;
      }
      .search-container {
        max-width: 100%;
      }
      header { flex-direction:column; text-align:center; gap: 16px; }
      .controls { flex-direction:column; }
      .btn { width:100%; max-width: 100%; justify-content:center; }
      .progress-container, .legend, .area-filter {
        padding: 14px;
      }
      .stats {
        grid-template-columns: 1fr 1fr;
      }
      .metricas-atraso {
        grid-template-columns: 1fr;
      }
      .semestre-selector-container {
        flex-direction: column;
        align-items: flex-start;
      }
      .semestre-info {
        margin-left: 0;
      }
    }

    .footer { 
      text-align:center; 
      padding: 20px 0; 
      margin-top: 30px; 
      font-size:13px; 
      color:#666; 
      border-top: 1px solid #e2e8f0; 
      transition: color .3s, border-color .3s; 
      font-family: var(--font-secondary);
    }
    body.active .footer { 
      color:#aaa; 
      border-top-color:#334155; 
    }
    .footer a { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      transition: color 0.2s;
    }
    body.active .footer a { 
      color: #818cf8; 
    }
    .footer a:hover { 
      text-decoration: underline; 
      color: var(--accent-dark);
    }
    
    /* Mensaje sin resultados */
    .no-results {
      text-align: center;
      padding: 30px 16px;
      font-size: 16px;
      color: #64748b;
      grid-column: 1 / -1;
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .no-results {
      background: rgba(30, 41, 59, 0.6);
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>IngenierÃ­a Civil en InformÃ¡tica</h1>
        <div class="subtitle">Malla interactiva y seguimiento de tu progreso acadÃ©mico</div>
      </div>
      <div class="dark-mode" id="theme-toggle" aria-label="Cambiar tema" role="switch" aria-checked="false" tabindex="0">
        <div class="circle">
          <ion-icon class="sun" name="sunny"></ion-icon>
          <ion-icon class="moon" name="moon"></ion-icon>
        </div>
      </div>
    </header>

    <!-- NUEVO: Selector de Semestre Actual -->
    <div class="semestre-selector-container">
      <span class="semestre-selector-label">ðŸ“… Semestre actual:</span>
      <select class="semestre-selector" id="select-semestre">
        <option value="1">1Â° Semestre</option>
        <option value="2">2Â° Semestre</option>
        <option value="3">3Â° Semestre</option>
        <option value="4">4Â° Semestre</option>
        <option value="5">5Â° Semestre</option>
        <option value="6">6Â° Semestre</option>
        <option value="7">7Â° Semestre</option>
        <option value="8">8Â° Semestre</option>
        <option value="9">9Â° Semestre</option>
        <option value="10">10Â° Semestre</option>
        <option value="11">11Â° Semestre</option>
      </select>
      <span class="semestre-info">Basado en tu progreso real</span>
    </div>

    <!-- Panel de AnÃ¡lisis de Atraso -->
    <div class="atraso-container" id="atraso-container" style="display: none;">
      <div class="atraso-header">
        <h3>ðŸ“Š AnÃ¡lisis de Progreso AcadÃ©mico</h3>
        <button class="btn btn-small" id="cerrar-analisis">
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>
      
      <div class="metricas-atraso">
        <div class="metrica-item">
          <div class="metrica-valor" id="metrica-atraso">0</div>
          <div class="metrica-label">Semestres de atraso</div>
        </div>
        <div class="metrica-item">
          <div class="metrica-valor" id="metrica-deficit">0</div>
          <div class="metrica-label">CrÃ©ditos en dÃ©ficit</div>
        </div>
        <div class="metrica-item">
          <div class="metrica-valor" id="metrica-criticos">0</div>
          <div class="metrica-label">Ramos crÃ­ticos</div>
        </div>
      </div>

      <div class="recomendaciones-container" id="recomendaciones-list">
        <!-- Las recomendaciones se insertarÃ¡n aquÃ­ -->
      </div>
    </div>

    <div class="progress-container" aria-live="polite">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="total-ramos">0</div>
          <div class="stat-label">Total ramos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="aprobados-ramos">0</div>
          <div class="stat-label">Aprobados</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="creditos-total">0/0</div>
          <div class="stat-label">CrÃ©ditos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="porcentaje">0%</div>
          <div class="stat-label">Progreso</div>
        </div>
      </div>
      <div class="progress" aria-label="Progreso total">
        <div class="progress-bar" id="barraProgreso">
          <div class="progress-text" id="textoProgreso">0%</div>
        </div>
      </div>
    </div>

    <div class="legend">
      <span><span class="cuadro lg-aprob"></span> Aprobado</span>
      <span><span class="cuadro lg-disp"></span> Disponible</span>
      <span><span class="cuadro lg-bloq"></span> Bloqueado</span>
    </div>

    <div class="area-filter" role="group" aria-label="Filtrar por Ã¡rea">
      <button class="area-btn" data-area="all">Todos</button>
      <button class="area-btn" data-area="programacion">ProgramaciÃ³n</button>
      <button class="area-btn" data-area="matematicas">MatemÃ¡ticas</button>
      <button class="area-btn" data-area="fisica">FÃ­sica</button>
      <button class="area-btn" data-area="ingenieria">IngenierÃ­a</button>
      <button class="area-btn" data-area="humanidades">Humanidades</button>
      <button class="area-btn" data-area="fofus">Fofus</button>
      <button class="area-btn" data-area="optativos">Optativos</button>
    </div>

    <div class="controls-container">
      <div class="controls">
        <button class="btn" id="btn-reset"><ion-icon name="refresh-outline"></ion-icon> Reiniciar</button>
        <button class="btn" id="toggle-disponibles"><ion-icon name="eye-outline"></ion-icon> Disponibles</button>
        <button class="btn" id="export-data"><ion-icon name="download-outline"></ion-icon> Exportar</button>
        <button class="btn" id="btn-analisis-atraso">
          <ion-icon name="analytics-outline"></ion-icon> AnÃ¡lisis de Atraso
        </button>
      </div>
      <div class="search-container">
        <ion-icon name="search-outline"></ion-icon>
        <input type="text" id="search-input" placeholder="Buscar por nombre o siglaâ€¦" aria-label="Buscar ramos">
      </div>
    </div>

    <div class="grid" id="malla" role="list"></div>
  </div>

  <div class="footer">
    Desarrollado por <a href="https://www.instagram.com/chelo_.morales" target="_blank" rel="noopener">Marcelo Morales</a>
  </div>

  <!-- Tooltip touch -->
  <div id="touch-tip" role="status" aria-live="polite"></div>

  <!-- Toasts -->
  <div id="toast-container"></div>

<script>
// ========= MODULARIZACIÃ“N: SeparaciÃ³n de responsabilidades =========

// MÃ³dulo de utilidades
const Utils = {
  // NormalizaciÃ³n de texto para bÃºsquedas
  normalizeText: (str) => (str || '').normalize('NFD').replace(/[Ì€-Í¯]/g, '').toLowerCase(),
  
  // Selectores DOM simplificados
  $: (sel) => document.querySelector(sel),
  $$: (sel) => Array.from(document.querySelectorAll(sel)),
  
  // Obtener variables CSS como pÃ­xeles
  cssVarPx: (name, fallback) => { 
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim(); 
    const n = parseFloat(v); 
    return Number.isFinite(n) ? n : fallback; 
  },
  
  // Debounce para optimizar bÃºsquedas
  debounce: (func, wait) => {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
};

// MÃ³dulo de tema
const ThemeManager = {
  init() {
    this.toggle = document.getElementById('theme-toggle');
    this.body = document.body;
    this.applyTheme(localStorage.getItem('modo') || 'light');
    this.setupEventListeners();
  },
  
  applyTheme(mode) {
    if (mode === 'dark') {
      this.body.classList.add('active');
    } else {
      this.body.classList.remove('active');
    }
    this.toggle?.setAttribute('aria-checked', mode === 'dark' ? 'true' : 'false');
  },
  
  swapTheme() {
    const isDark = this.body.classList.toggle('active');
    const modo = isDark ? 'dark' : 'light';
    localStorage.setItem('modo', modo);
    this.toggle?.setAttribute('aria-checked', isDark ? 'true' : 'false');
  },
  
  setupEventListeners() {
    this.toggle?.addEventListener('click', () => this.swapTheme());
    this.toggle?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.swapTheme();
      }
    });
  }
};

// MÃ³dulo de notificaciones
const NotificationManager = {
  init() {
    this.toastContainer = document.getElementById('toast-container');
  },
  
  showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <ion-icon name="${type === 'success' ? 'checkmark-circle' : 'information-circle'}"></ion-icon>
      <span>${message}</span>
    `;
    
    this.toastContainer.appendChild(toast);
    
    // Remover despuÃ©s de 3 segundos
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) translateY(-20px)';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  },
  
  createConfetti() {
    const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
    
    for (let i = 0; i < 30; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.opacity = '1';
      document.body.appendChild(confetti);
      
      // AnimaciÃ³n
      const animation = confetti.animate([
        { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
        { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
      ], {
        duration: 1000 + Math.random() * 1000,
        easing: 'cubic-bezier(0.1, 0.8, 0.2, 1)'
      });
      
      animation.onfinish = () => {
        if (confetti.parentNode) {
          confetti.parentNode.removeChild(confetti);
        }
      };
    }
  }
};

// MÃ³dulo de datos de la malla
const CurriculumData = {
  cursosRaw: [
    // Semestre 1
    {sem:1, sigla:"MAT1001", nombre:"Fundamentos de MatemÃ¡ticas para IngenierÃ­a", creditos:6, area:"matematicas", prereqs:[]},
    {sem:1, sigla:"ICI1243", nombre:"IntroducciÃ³n a la IngenierÃ­a InformÃ¡tica", creditos:4, area:"ingenieria", prereqs:[]},
    {sem:1, sigla:"ICI1241", nombre:"Fundamentos de Algoritmos", creditos:4, area:"programacion", prereqs:[]},
    {sem:1, sigla:"ICI1458", nombre:"Bienestar y Aprendizaje Universitario", creditos:2, area:"humanidades", prereqs:[]},
    
    // Semestre 2
    {sem:2, sigla:"MAT1002", nombre:"CÃ¡lculo Diferencial e Integral", creditos:6, area:"matematicas", prereqs:["MAT1001"]},
    {sem:2, sigla:"MAT1004", nombre:"Ãlgebra Lineal", creditos:4, area:"matematicas", prereqs:["MAT1001"]},
    {sem:2, sigla:"ICI1242", nombre:"Fundamentos de ProgramaciÃ³n", creditos:4, area:"programacion", prereqs:["ICI1241"]},
    {sem:2, sigla:"FIN100-14", nombre:"Desarrollo Integral y ComunicaciÃ³n para IngenierÃ­a", creditos:3, area:"humanidades", prereqs:[]},
    {sem:2, sigla:"FF1", nombre:"FormaciÃ³n Fundamental", creditos:2, area:"fofus", prereqs:[]},
    
    // Semestre 3
    {sem:3, sigla:"FIS1002", nombre:"FÃ­sica para IngenierÃ­a", creditos:5, area:"fisica", prereqs:["MAT1001"]},
    {sem:3, sigla:"MAT1003", nombre:"CÃ¡lculo en Varias Variables", creditos:4, area:"matematicas", prereqs:["MAT1002"]},
    {sem:3, sigla:"ICI2145", nombre:"AnÃ¡lisis Inteligente de Datos", creditos:4, area:"programacion", prereqs:["MAT1002"]},
    {sem:3, sigla:"ICI2240", nombre:"Estructura de Datos", creditos:4, area:"programacion", prereqs:["ICI1242"]},
    {sem:3, sigla:"ICR010", nombre:"AntropologÃ­a Cristiana", creditos:2, area:"fofus", prereqs:[]},
    {sem:3, sigla:"FF2", nombre:"FormaciÃ³n Fundamental 2", creditos:2, area:"fofus", prereqs:[]},
    
    // Semestre 4
    {sem:4, sigla:"FIS2120", nombre:"FÃ­sica Electromagnetismo", creditos:3, area:"fisica", prereqs:["FIS1002"]},
    {sem:4, sigla:"ICI2141", nombre:"MÃ©todos NumÃ©ricos", creditos:3, area:"matematicas", prereqs:["ICI1242"]},
    {sem:4, sigla:"ICI2242", nombre:"AnÃ¡lisis y DiseÃ±o de Algoritmos", creditos:4, area:"programacion", prereqs:[]},
    {sem:4, sigla:"ICI2241", nombre:"ProgramaciÃ³n Avanzada", creditos:4, area:"programacion", prereqs:["ICI2240"]},
    {sem:4, sigla:"ICR020", nombre:"Ã‰tica Cristiana", creditos:2, area:"fofus", prereqs:[]},
    {sem:4, sigla:"ING9001", nombre:"InglÃ©s 1", creditos:2, area:"humanidades", prereqs:[]},
    
    // Semestre 5
    {sem:5, sigla:"FIS3149", nombre:"FÃ­sica Moderna", creditos:3, area:"fisica", prereqs:["FIS2120"]},
    {sem:5, sigla:"ICI3245", nombre:"AutÃ³matas y Compiladores", creditos:3, area:"programacion", prereqs:["ICI2241"]},
    {sem:5, sigla:"ICI3240", nombre:"Base de Datos", creditos:4, area:"programacion", prereqs:["ICI1242"]},
    {sem:5, sigla:"ICI3244", nombre:"Inteligencia Artificial", creditos:4, area:"programacion", prereqs:["ICI2242"]},
    {sem:5, sigla:"ICI3344", nombre:"Hardware y Sistemas Operativos", creditos:4, area:"ingenieria", prereqs:["ICI1242"]},
    {sem:5, sigla:"ING9002", nombre:"InglÃ©s 2", creditos:2, area:"humanidades", prereqs:["ING9001"]},
    
    // Semestre 6
    {sem:6, sigla:"ICI3150", nombre:"Ciencia y TecnologÃ­a", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:6, sigla:"ICI3170", nombre:"EstadÃ­stica Computacional", creditos:4, area:"matematicas", prereqs:["MAT1003"]},
    {sem:6, sigla:"ICA4121", nombre:"AdministraciÃ³n de Empresas", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:6, sigla:"ICI3246", nombre:"Modelamiento de Software", creditos:4, area:"programacion", prereqs:["ICI3240"]},
    {sem:6, sigla:"ICI3343", nombre:"Redes de Computadores", creditos:4, area:"ingenieria", prereqs:["ICI3245"]},
    {sem:6, sigla:"ING9003", nombre:"InglÃ©s 3", creditos:2, area:"humanidades", prereqs:["ING9002"]},
    
    // Semestre 7
    {sem:7, sigla:"ICI4150", nombre:"RobÃ³tica y Sistemas AutÃ³nomos", creditos:3, area:"ingenieria", prereqs:["ICI3343"]},
    {sem:7, sigla:"ICI4151", nombre:"OptimizaciÃ³n", creditos:4, area:"matematicas", prereqs:[]},
    {sem:7, sigla:"ICI4244", nombre:"IngenierÃ­a de Software", creditos:4, area:"ingenieria", prereqs:["ICI3246"]},
    {sem:7, sigla:"ICI4247", nombre:"IngenierÃ­a Web y MÃ³vil", creditos:4, area:"programacion", prereqs:["ICI3246"]},
    {sem:7, sigla:"ICI4344", nombre:"ComputaciÃ³n Paralela y Distribuida", creditos:4, area:"ingenieria", prereqs:["ICI3343"]},
    {sem:7, sigla:"ING9004", nombre:"InglÃ©s 4", creditos:2, area:"humanidades", prereqs:["ING9003"]},
    
    // Semestre 8
    {sem:8, sigla:"ICA4161", nombre:"EconomÃ­a y Finanzas", creditos:3, area:"ingenieria", prereqs:["ICA4121"]},
    {sem:8, sigla:"ICI4248", nombre:"IngenierÃ­a de Requerimientos", creditos:4, area:"programacion", prereqs:["ICI4247"]},
    {sem:8, sigla:"ICI4541", nombre:"Taller de Base de Datos", creditos:4, area:"programacion", prereqs:["ICI3240"]},
    {sem:8, sigla:"ICI4370", nombre:"Ciberseguridad", creditos:4, area:"ingenieria", prereqs:["ICI3343"]},
    {sem:8, sigla:"FF3", nombre:"FormaciÃ³n Fundamental 3", creditos:2, area:"fofus", prereqs:[]},
    {sem:8, sigla:"OPT1", nombre:"Optativo I", creditos:4, area:"optativos", prereqs:[]},
    
    // Semestre 9
    {sem:9, sigla:"ICI5441", nombre:"AdministraciÃ³n de proyectos informÃ¡ticos", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:9, sigla:"ICI5545", nombre:"Taller IngenierÃ­a de Software", creditos:4, area:"ingenieria", prereqs:["ICI4244"]},
    {sem:9, sigla:"ICI5442", nombre:"TecnologÃ­as Emergentes", creditos:4, area:"ingenieria", prereqs:[]},
    {sem:9, sigla:"ICI5247", nombre:"Experiencia del Usuario", creditos:3, area:"ingenieria", prereqs:["ICI4248"]},
    {sem:9, sigla:"ICI5475", nombre:"Negocios, innovaciÃ³n y emprendimiento", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:9, sigla:"OPT2", nombre:"Optativo II", creditos:4, area:"optativos", prereqs:[]},
    
    // Semestre 10
    {sem:10, sigla:"ICI5444", nombre:"Taller de FormulaciÃ³n de Proyectos InformÃ¡ticos", creditos:4, area:"ingenieria", prereqs:["ICI5441"]},
    {sem:10, sigla:"ICI5541", nombre:"Seminario de TÃ­tulo", creditos:5, area:"ingenieria", prereqs:["ICA4161", "ICI4248", "ICI4541", "ICI4370", "ICI5441", "ICI5545", "ICI5442", "ICI5247", "ICI5475", "ICI4151", "ICI3170", "ICI3344", "ICI3244"]},
    {sem:10, sigla:"ICI5345", nombre:"LegislaciÃ³n, Ã‰tica y TecnolÃ³gica", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:10, sigla:"ICI5476", nombre:"Taller de Liderazgo y Trabajo en Equipo", creditos:3, area:"ingenieria", prereqs:[]},
    {sem:10, sigla:"OPT3", nombre:"Optativo III", creditos:4, area:"optativos", prereqs:[]},
    
    // Semestre 11
    {sem:11, sigla:"ICI6541", nombre:"Proyecto de TÃ­tulo", creditos:12, area:"ingenieria", prereqs:["ICI5541"]},
    {sem:11, sigla:"OPT4", nombre:"Optativo IV", creditos:4, area:"optativos", prereqs:[]}
  ],
  
  // Estructuras de datos procesadas
  siglaToNombre: new Map(),
  ramos: {},
  creditosRamos: {},
  prereqsPorNombre: {},
  porSemestre: {},
  maxSemestre: 0,
  
  init() {
    this.processData();
  },
  
  processData() {
    // Mapeo de siglas a nombres
    this.siglaToNombre = new Map(this.cursosRaw.map(c => [c.sigla, c.nombre]));
    
    // Inicializar estructuras
    this.ramos = {};
    this.creditosRamos = {};
    this.prereqsPorNombre = {};
    this.porSemestre = {};
    
    // Procesar cada curso
    for (const c of this.cursosRaw) {
      this.ramos[c.nombre] = { 
        semestre: c.sem, 
        area: c.area, 
        sigla: c.sigla, 
        abre: [] 
      };
      this.creditosRamos[c.nombre] = c.creditos ?? 0;
      this.prereqsPorNombre[c.nombre] = (c.prereqs || [])
        .map(sig => this.siglaToNombre.get(sig))
        .filter(Boolean);
    }
    
    // Procesar dependencias inversas (quÃ© cursos abre cada curso)
    for (const [nombre, lista] of Object.entries(this.prereqsPorNombre)) {
      for (const p of lista) {
        if (this.ramos[p]) {
          this.ramos[p].abre.push(nombre);
        }
      }
    }
    
    // Organizar por semestre
    for (const [nombre, info] of Object.entries(this.ramos)) {
      if (!this.porSemestre[info.semestre]) {
        this.porSemestre[info.semestre] = [];
      }
      this.porSemestre[info.semestre].push(nombre);
    }
    
    // Encontrar el semestre mÃ¡ximo
    this.maxSemestre = Math.max(...Object.values(this.ramos).map(r => r.semestre));
  }
};

// MÃ³dulo de anÃ¡lisis de atraso MEJORADO
const AtrasoAnalyzer = {
  // ConfiguraciÃ³n de carga acadÃ©mica esperada
  config: {
    creditosPorSemestreIdeal: 24, // Carga tÃ­pica por semestre
    semestresTotales: 11, // DuraciÃ³n formal de la carrera
    margenAtraso: 6, // CrÃ©ditos por debajo del ideal para considerar atraso
  },

  init() {
    this.config = { ...this.config, ...JSON.parse(localStorage.getItem('config_atraso') || '{}') };
  },

  // NUEVO: Obtener semestre actual del usuario
  getSemestreActual() {
    return MallaApp.state.semestreActual || 1;
  },

  // ACTUALIZADO: Calcular mÃ©tricas de atraso CON semestre manual
  calcularMetricasAtraso() {
    const { completados: creditosAprobados } = MallaApp.calcularCreditos();
    const semestreIdeal = Math.ceil(creditosAprobados / this.config.creditosPorSemestreIdeal);
    
    // NUEVO: Usar semestre indicado por el usuario
    const semestreReal = this.getSemestreActual();

    const atrasoSemestral = Math.max(0, semestreReal - semestreIdeal);
    const creditosEsperados = semestreReal * this.config.creditosPorSemestreIdeal;
    const deficitCreditos = Math.max(0, creditosEsperados - creditosAprobados);

    return {
      semestreIdeal,
      semestreReal,
      atrasoSemestral,
      deficitCreditos,
      enAtraso: atrasoSemestral > 0 || deficitCreditos > this.config.margenAtraso
    };
  },

  // NUEVO: AnÃ¡lisis de ramos del semestre actual
  analizarSemestreActual() {
    const semestreActual = this.getSemestreActual();
    const ramosSemestreActual = CurriculumData.porSemestre[semestreActual] || [];
    
    const analisis = {
      semestre: semestreActual,
      totalRamos: ramosSemestreActual.length,
      aprobados: 0,
      disponibles: 0,
      bloqueados: 0,
      ramosPendientes: []
    };

    ramosSemestreActual.forEach(ramo => {
      if (MallaApp.isApproved(ramo)) {
        analisis.aprobados++;
      } else if (MallaApp.estaDisponible(ramo)) {
        analisis.disponibles++;
        analisis.ramosPendientes.push({
          nombre: ramo,
          sigla: CurriculumData.ramos[ramo].sigla,
          creditos: CurriculumData.creditosRamos[ramo],
          disponible: true
        });
      } else {
        analisis.bloqueados++;
        analisis.ramosPendientes.push({
          nombre: ramo,
          sigla: CurriculumData.ramos[ramo].sigla,
          creditos: CurriculumData.creditosRamos[ramo],
          disponible: false,
          prerrequisitosFaltantes: MallaApp.prerequisitosDe(ramo)
            .filter(p => !MallaApp.isApproved(p))
        });
      }
    });

    return analisis;
  },

  // ACTUALIZADO: Generar recomendaciones MEJORADAS
  generarRecomendaciones() {
    const problemas = this.identificarProblemas();
    const recomendaciones = [];
    const semestreActual = this.getSemestreActual();
    const analisisSemestre = this.analizarSemestreActual();

    // NUEVO: AnÃ¡lisis especÃ­fico del semestre actual
    if (analisisSemestre.aprobados === 0 && semestreActual > 1) {
      recomendaciones.push({
        tipo: 'semestre_sin_aprobados',
        titulo: 'âš ï¸ Semestre actual sin progreso',
        acciones: [
          `No has aprobado ningÃºn ramo del ${semestreActual}Â° semestre`,
          'Considera enfocarte en los ramos disponibles este semestre',
          'Revisa si necesitas ayuda acadÃ©mica'
        ],
        prioridad: 'alta'
      });
    }

    if (analisisSemestre.disponibles > 0) {
      recomendaciones.push({
        tipo: 'ramos_disponibles_semestre',
        titulo: `ðŸŽ¯ Ramos disponibles este semestre (${semestreActual}Â°)`,
        acciones: analisisSemestre.ramosPendientes
          .filter(r => r.disponible)
          .map(r => `${r.sigla} - ${r.nombre} (${r.creditos} crÃ©ditos)`)
          .slice(0, 5),
        prioridad: 'media'
      });
    }

    // Recomendaciones existentes (pero mejoradas)
    if (problemas.some(p => p.prioridad === 'alta')) {
      recomendaciones.push({
        tipo: 'prioridad_alta',
        titulo: 'ðŸš¨ AtenciÃ³n: Atraso CrÃ­tico Detectado',
        acciones: [
          `Vas ${this.calcularMetricasAtraso().atrasoSemestral} semestre(s) atrasado`,
          'Prioriza ramos crÃ­ticos que desbloqueen mÃºltiples opciones',
          'Considera tomar carga acadÃ©mica completa este semestre'
        ],
        prioridad: 'alta'
      });
    }

    // AnÃ¡lisis de ramos crÃ­ticos (mejorado)
    const ramosCriticos = this.identificarRamosCriticos();
    if (ramosCriticos.length > 0) {
      recomendaciones.push({
        tipo: 'ramos_criticos',
        titulo: 'ðŸ“š Ramos CrÃ­ticos Pendientes',
        acciones: ramosCriticos.map(ramo => 
          `"${ramo.nombre}" (Sem ${ramo.semestre}) - Bloquea ${ramo.ramosBloqueados} ramos ${ramo.disponible ? 'âœ… DISPONIBLE' : 'âŒ BLOQUEADO'}`
        ),
        prioridad: ramosCriticos.some(r => r.disponible) ? 'alta' : 'media'
      });
    }

    // NUEVO: PlanificaciÃ³n para prÃ³ximo semestre
    if (semestreActual < CurriculumData.maxSemestre) {
      const ramosProximoSemestre = this.sugerirRamosProximoSemestre(semestreActual);
      if (ramosProximoSemestre.length > 0) {
        recomendaciones.push({
          tipo: 'planificacion_proximo_semestre',
          titulo: `ðŸ“… PlanificaciÃ³n para ${semestreActual + 1}Â° Semestre`,
          acciones: ramosProximoSemestre,
          prioridad: 'media'
        });
      }
    }

    return recomendaciones.sort((a, b) => {
      const prioridades = { alta: 3, media: 2, baja: 1 };
      return prioridades[b.prioridad] - prioridades[a.prioridad];
    });
  },

  // ACTUALIZADO: Sugerir ramos MEJORADO
  sugerirRamosProximoSemestre(semestreActual) {
    const sugerencias = [];
    const proximoSemestre = semestreActual + 1;

    // Ramos del prÃ³ximo semestre disponibles
    const ramosProximoSem = (CurriculumData.porSemestre[proximoSemestre] || [])
      .filter(ramo => !MallaApp.isApproved(ramo) && MallaApp.estaDisponible(ramo));

    // Priorizar por impacto
    const ramosCriticos = this.identificarRamosCriticos();
    const criticosDisponibles = ramosCriticos
      .filter(ramo => ramo.disponible && ramosProximoSem.includes(ramo.nombre))
      .slice(0, 2);

    criticosDisponibles.forEach(ramo => {
      sugerencias.push(`ðŸŸ¢ ${ramo.sigla} - CRÃTICO (bloquea ${ramo.ramosBloqueados} ramos)`);
    });

    // Ramos por crÃ©ditos (mayor a menor)
    const ramosPorCreditos = ramosProximoSem
      .filter(ramo => !criticosDisponibles.some(c => c.nombre === ramo))
      .sort((a, b) => (CurriculumData.creditosRamos[b] || 0) - (CurriculumData.creditosRamos[a] || 0))
      .slice(0, 4 - criticosDisponibles.length);

    ramosPorCreditos.forEach(ramo => {
      const creditos = CurriculumData.creditosRamos[ramo] || 0;
      sugerencias.push(`ðŸ”µ ${CurriculumData.ramos[ramo].sigla} - ${creditos} crÃ©ditos`);
    });

    return sugerencias;
  },

  // Identificar ramos que son prerrequisitos de muchos otros
  identificarRamosCriticos() {
    const criticos = [];
    const umbralImportancia = 3; // NÃºmero mÃ­nimo de ramos que dependen

    for (const [nombre, info] of Object.entries(CurriculumData.ramos)) {
      if (!MallaApp.isApproved(nombre) && info.abre.length >= umbralImportancia) {
        const ramosBloqueados = info.abre.filter(abre => !MallaApp.isApproved(abre));
        if (ramosBloqueados.length > 0) {
          criticos.push({
            nombre,
            sigla: info.sigla,
            semestre: info.semestre,
            ramosBloqueados: ramosBloqueados.length,
            disponible: MallaApp.estaDisponible(nombre)
          });
        }
      }
    }

    return criticos.sort((a, b) => b.ramosBloqueados - a.ramosBloqueados);
  },

  // Analizar secuencias de ramos bloqueados
  analizarSecuenciasBloqueadas() {
    const secuencias = [];
    const ramosPendientes = Object.keys(CurriculumData.ramos).filter(nombre => 
      !MallaApp.isApproved(nombre)
    );

    ramosPendientes.forEach(nombre => {
      const rutaMasLarga = this.encontrarRutaMasLarga(nombre);
      if (rutaMasLarga.length > 2) { // Secuencia de al menos 3 ramos
        secuencias.push({
          inicio: nombre,
          longitud: rutaMasLarga.length,
          ruta: rutaMasLarga
        });
      }
    });

    return secuencias.sort((a, b) => b.longitud - a.longitud).slice(0, 3);
  },

  // Encontrar la ruta de dependencias mÃ¡s larga
  encontrarRutaMasLarga(ramoInicio) {
    let rutaMasLarga = [];
    
    const dfs = (ramoActual, rutaActual) => {
      const rutaNueva = [...rutaActual, ramoActual];
      if (rutaNueva.length > rutaMasLarga.length) {
        rutaMasLarga = rutaNueva;
      }

      const dependientes = CurriculumData.ramos[ramoActual]?.abre || [];
      dependientes.forEach(dep => {
        if (!MallaApp.isApproved(dep) && !rutaNueva.includes(dep)) {
          dfs(dep, rutaNueva);
        }
      });
    };

    dfs(ramoInicio, []);
    return rutaMasLarga;
  },

  // Analizar distribuciÃ³n de carga por semestre
  analizarDistribucionCarga() {
    const creditosPorSemestre = {};
    
    for (let sem = 1; sem <= CurriculumData.maxSemestre; sem++) {
      const ramosSem = CurriculumData.porSemestre[sem] || [];
      creditosPorSemestre[sem] = ramosSem
        .filter(ramo => MallaApp.isApproved(ramo))
        .reduce((sum, ramo) => sum + (CurriculumData.creditosRamos[ramo] || 0), 0);
    }

    // Encontrar semestres con carga muy baja
    const semestresBajos = Object.entries(creditosPorSemestre)
      .filter(([sem, creditos]) => creditos < this.config.creditosPorSemestreIdeal * 0.6)
      .map(([sem]) => parseInt(sem));

    if (semestresBajos.length > 0) {
      return {
        tipo: 'carga_desbalanceada',
        mensaje: `Carga acadÃ©mica baja en ${semestresBajos.length} semestre(s)`,
        detalles: `Semestres con carga baja: ${semestresBajos.join(', ')}`,
        prioridad: 'baja'
      };
    }

    return null;
  },

  // Identificar problemas de atraso
  identificarProblemas() {
    const problemas = [];
    const { atrasoSemestral, deficitCreditos } = this.calcularMetricasAtraso();

    // AnÃ¡lisis de ramos crÃ­ticos no aprobados
    const ramosCriticos = this.identificarRamosCriticos();
    if (ramosCriticos.length > 0) {
      problemas.push({
        tipo: 'ramos_criticos',
        mensaje: `Tienes ${ramosCriticos.length} ramo(s) crÃ­tico(s) pendiente(s)`,
        detalles: ramosCriticos,
        prioridad: 'alta'
      });
    }

    // AnÃ¡lisis de secuencias bloqueadas
    const secuenciasBloqueadas = this.analizarSecuenciasBloqueadas();
    if (secuenciasBloqueadas.length > 0) {
      problemas.push({
        tipo: 'secuencias_bloqueadas',
        mensaje: 'Secuencias acadÃ©micas bloqueadas detectadas',
        detalles: secuenciasBloqueadas,
        prioridad: 'media'
      });
    }

    // AnÃ¡lisis de distribuciÃ³n de carga
    const distribucionProblema = this.analizarDistribucionCarga();
    if (distribucionProblema) {
      problemas.push(distribucionProblema);
    }

    // AnÃ¡lisis general de atraso
    if (atrasoSemestral > 0) {
      problemas.push({
        tipo: 'atraso_semestral',
        mensaje: `Vas ${atrasoSemestral} semestre(s) atrasado`,
        detalles: `Semestre ideal: ${this.calcularMetricasAtraso().semestreIdeal}, Actual: ${this.calcularMetricasAtraso().semestreReal}`,
        prioridad: atrasoSemestral > 1 ? 'alta' : 'media'
      });
    }

    if (deficitCreditos > this.config.margenAtraso) {
      problemas.push({
        tipo: 'deficit_creditos',
        mensaje: `Tienes un dÃ©ficit de ${deficitCreditos} crÃ©ditos`,
        detalles: `Considera aumentar tu carga acadÃ©mica este semestre`,
        prioridad: 'media'
      });
    }

    return problemas;
  }
};

// MÃ³dulo principal de la aplicaciÃ³n ACTUALIZADO
const MallaApp = {
  // Estado de la aplicaciÃ³n
  state: {
    aprobadasSiglas: [],
    areaSeleccionada: 'all',
    busqueda: '',
    mostrarSoloDisponibles: false,
    nombreToEl: new Map(),
    estadoAnterior: new Map(),
    // NUEVO: Semestre actual del usuario
    semestreActual: 1
  },
  
  // InicializaciÃ³n
  init() {
    // Inicializar mÃ³dulos
    ThemeManager.init();
    NotificationManager.init();
    CurriculumData.init();
    AtrasoAnalyzer.init();
    
    // Configurar persistencia
    this.setupPersistence();
    
    // Cargar datos aprobados
    this.loadApprovedCourses();
    
    // NUEVO: Cargar semestre actual guardado
    this.loadSemestreActual();
    
    // Renderizar interfaz
    this.render();
    
    // Configurar event listeners
    this.setupEventListeners();
    
    // Configurar tooltips tÃ¡ctiles
    this.setupTouchTooltips();
    
    // Configurar navegaciÃ³n por teclado
    this.setupKeyboardNavigation();
  },
  
  // NUEVO: Cargar semestre actual
  loadSemestreActual() {
    const semestreGuardado = localStorage.getItem('semestre_actual');
    if (semestreGuardado) {
      this.state.semestreActual = parseInt(semestreGuardado);
      // Actualizar el selector en la UI
      const selector = document.getElementById('select-semestre');
      if (selector) {
        selector.value = this.state.semestreActual;
      }
    }
  },
  
  // NUEVO: Guardar semestre actual
  guardarSemestreActual(semestre) {
    this.state.semestreActual = parseInt(semestre);
    localStorage.setItem('semestre_actual', semestre);
    // Recalcular anÃ¡lisis si estÃ¡ visible
    if (document.getElementById('atraso-container').style.display !== 'none') {
      this.mostrarAnalisisAtraso();
    }
  },
  
  // ConfiguraciÃ³n de persistencia
  setupPersistence() {
    const firmaMalla = JSON.stringify(CurriculumData.cursosRaw.map(c => c.sigla).sort());
    const firmaGuardada = localStorage.getItem('firma_malla');
    
    // Si la malla ha cambiado, limpiar datos guardados
    if (firmaGuardada && firmaGuardada !== firmaMalla) {
      localStorage.removeItem('ramos_aprobados_siglas');
    }
    
    localStorage.setItem('firma_malla', firmaMalla);
  },
  
  // Cargar cursos aprobados
  loadApprovedCourses() {
    this.state.aprobadasSiglas = JSON.parse(localStorage.getItem('ramos_aprobados_siglas') || '[]');
    const setSiglasValidas = new Set(CurriculumData.cursosRaw.map(c => c.sigla));
    
    // Filtrar solo siglas vÃ¡lidas
    this.state.aprobadasSiglas = this.state.aprobadasSiglas.filter(s => setSiglasValidas.has(s));
    localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(this.state.aprobadasSiglas));
  },
  
  // Obtener nombres de cursos aprobados
  aprobadosNombres() {
    return this.state.aprobadasSiglas
      .map(s => CurriculumData.siglaToNombre.get(s))
      .filter(Boolean);
  },
  
  // Verificar si un curso estÃ¡ aprobado
  isApproved(nombre) {
    return new Set(this.aprobadosNombres()).has(nombre);
  },
  
  // Calcular crÃ©ditos
  calcularCreditos() {
    let total = 0, completados = 0;
    for (const [nombre] of Object.entries(CurriculumData.ramos)) {
      const c = CurriculumData.creditosRamos[nombre] ?? 0; 
      total += c; 
      if (this.isApproved(nombre)) completados += c;
    }
    const porcentaje = total > 0 ? Math.round((completados / total) * 100) : 0;
    return { total, completados, porcentaje };
  },
  
  // Obtener prerrequisitos de un curso
  prerequisitosDe(nombre) {
    return [...(CurriculumData.prereqsPorNombre[nombre] || [])];
  },
  
  // Obtener todos los cursos que dependen de un curso
  obtenerTodosDependientes(nombre) {
    const out = new Set();
    const dfs = (n) => {
      for (const d of (CurriculumData.ramos[n]?.abre || [])) {
        if (!out.has(d)) {
          out.add(d);
          dfs(d);
        }
      }
    };
    dfs(nombre);
    return [...out];
  },
  
  // Verificar si un curso estÃ¡ disponible
  estaDisponible(nombre) {
    return this.prerequisitosDe(nombre).every(p => this.isApproved(p));
  },
  
  // Aprobar o desaprobar un curso
  toggleApproval(ramoNombre) {
    const sigla = CurriculumData.ramos[ramoNombre]?.sigla;
    if (!sigla) return;
    
    const isApproved = this.isApproved(ramoNombre);
    
    if (isApproved) {
      // Desaprobar curso y sus dependencias
      const dep = this.obtenerTodosDependientes(ramoNombre);
      const aEliminar = [ramoNombre, ...dep];
      
      // AnimaciÃ³n de desaprobaciÃ³n
      Utils.$$('.ramo').forEach(el => {
        const n = el.querySelector('.ramo-nombre')?.textContent;
        if (n && aEliminar.includes(n)) el.classList.add('retirado');
      });
      
      const depSiglas = aEliminar.map(n => CurriculumData.ramos[n]?.sigla).filter(Boolean);
      this.state.aprobadasSiglas = this.state.aprobadasSiglas.filter(s => !depSiglas.includes(s));
      localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(this.state.aprobadasSiglas));
      
      this.render();
      NotificationManager.showToast(`Has desaprobado ${ramoNombre} y sus dependencias`, 'info');
    } else {
      // Aprobar curso si estÃ¡ disponible
      if (this.estaDisponible(ramoNombre)) {
        if (!this.state.aprobadasSiglas.includes(sigla)) {
          this.state.aprobadasSiglas.push(sigla);
        }
        localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(this.state.aprobadasSiglas));
        
        this.render();
        NotificationManager.showToast(`Â¡Felicidades! Has aprobado ${ramoNombre}`, 'success');
        NotificationManager.createConfetti();
      } else {
        NotificationManager.showToast('No puedes aprobar este ramo hasta completar sus prerrequisitos', 'info');
      }
    }
  },
  
  // Reiniciar progreso
  resetProgress() {
    if (confirm('Â¿EstÃ¡s seguro de reiniciar todo el progreso?')) {
      localStorage.removeItem('ramos_aprobados_siglas');
      localStorage.removeItem('semestre_actual');
      this.state.aprobadasSiglas = [];
      this.state.semestreActual = 1;
      const selector = document.getElementById('select-semestre');
      if (selector) selector.value = '1';
      this.render();
      NotificationManager.showToast('Progreso reiniciado correctamente', 'info');
    }
  },
  
  // Exportar datos
  exportData() {
    const data = {
      aprobados: this.state.aprobadasSiglas,
      progreso: this.calcularCreditos(),
      semestreActual: this.state.semestreActual,
      fecha: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `progreso-malla-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    NotificationManager.showToast('Datos exportados correctamente', 'success');
  },
  
  // ACTUALIZADO: Mostrar anÃ¡lisis de atraso MEJORADO
  mostrarAnalisisAtraso() {
    const container = Utils.$('#atraso-container');
    const metricas = AtrasoAnalyzer.calcularMetricasAtraso();
    const recomendaciones = AtrasoAnalyzer.generarRecomendaciones();
    const analisisSemestre = AtrasoAnalyzer.analizarSemestreActual();

    // Actualizar mÃ©tricas
    Utils.$('#metrica-atraso').textContent = metricas.atrasoSemestral;
    Utils.$('#metrica-atraso').className = `metrica-valor ${
      metricas.atrasoSemestral > 1 ? 'critico' : 
      metricas.atrasoSemestral > 0 ? 'advertencia' : 'normal'
    }`;

    Utils.$('#metrica-deficit').textContent = metricas.deficitCreditos;
    Utils.$('#metrica-deficit').className = `metrica-valor ${
      metricas.deficitCreditos > 12 ? 'critico' : 
      metricas.deficitCreditos > 6 ? 'advertencia' : 'normal'
    }`;

    const ramosCriticos = AtrasoAnalyzer.identificarRamosCriticos();
    Utils.$('#metrica-criticos').textContent = ramosCriticos.length;
    Utils.$('#metrica-criticos').className = `metrica-valor ${
      ramosCriticos.length > 3 ? 'critico' : 
      ramosCriticos.length > 1 ? 'advertencia' : 'normal'
    }`;

    // Mostrar recomendaciones
    const recomendacionesContainer = Utils.$('#recomendaciones-list');
    recomendacionesContainer.innerHTML = '';

    if (recomendaciones.length === 0) {
      recomendacionesContainer.innerHTML = `
        <div class="recomendacion-item normal">
          <div class="recomendacion-titulo">ðŸŽ‰ Â¡Excelente progreso!</div>
          <div class="recomendacion-acciones">
            <p>Vas al dÃ­a con tu plan de estudios. Â¡Sigue asÃ­!</p>
            <p><strong>Semestre ${this.state.semestreActual}Â°:</strong> ${analisisSemestre.aprobados}/${analisisSemestre.totalRamos} ramos aprobados</p>
          </div>
        </div>
      `;
    } else {
      recomendaciones.forEach(rec => {
        const item = document.createElement('div');
        item.className = `recomendacion-item ${rec.prioridad === 'alta' ? 'alta' : rec.prioridad === 'media' ? 'media' : 'normal'}`;
        
        item.innerHTML = `
          <div class="recomendacion-titulo">${rec.titulo}</div>
          <div class="recomendacion-acciones">
            <ul>
              ${rec.acciones.map(acc => `<li>${acc}</li>`).join('')}
            </ul>
          </div>
        `;
        
        recomendacionesContainer.appendChild(item);
      });
    }

    container.style.display = 'block';
    
    // Scroll suave al panel
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  },
  
  // Sincronizar anchos de tooltips
  syncBoxWidths() {
    Utils.$$('.ramo').forEach(el => {
      const w = Math.round(el.getBoundingClientRect().width);
      el.style.setProperty('--box-w', w + 'px');
    });
  },
  
  // Resaltar prerrequisitos
  highlightPrereqs(nombre, on) {
    const selfEl = this.state.nombreToEl.get(nombre);
    if (selfEl) selfEl.classList.toggle('is-self', on);
    
    for (const p of (CurriculumData.prereqsPorNombre[nombre] || [])) {
      this.state.nombreToEl.get(p)?.classList.toggle('is-prereq', on);
    }
  },
  
  // Renderizar la malla
  render() {
    const totalRamos = Object.keys(CurriculumData.ramos).length;
    const aprobadosList = this.aprobadosNombres();
    const { total: creditosTotal, completados: creditosAprobados, porcentaje } = this.calcularCreditos();
    
    // Actualizar estadÃ­sticas
    Utils.$('#total-ramos').textContent = totalRamos;
    Utils.$('#aprobados-ramos').textContent = aprobadosList.length;
    Utils.$('#creditos-total').textContent = `${creditosAprobados}/${creditosTotal}`;
    Utils.$('#porcentaje').textContent = `${porcentaje}%`;
    Utils.$('#barraProgreso').style.width = porcentaje + '%';
    Utils.$('#textoProgreso').textContent = porcentaje + '%';
    
    const frag = document.createDocumentFragment();
    let semestresRenderizados = 0;
    const nuevoEstado = new Map();
    this.state.nombreToEl.clear();
    
    // Renderizar cada semestre
    for (let sem = 1; sem <= CurriculumData.maxSemestre; sem++) {
      const ramosSem = (CurriculumData.porSemestre[sem] || [])
        .filter(ramo => {
          // Filtro por Ã¡rea
          if (this.state.areaSeleccionada !== 'all' && this.state.areaSeleccionada !== 'none') {
            if (CurriculumData.ramos[ramo].area !== this.state.areaSeleccionada) return false;
          }
          
          // Filtro por bÃºsqueda
          if (this.state.busqueda) {
            const b = Utils.normalizeText(this.state.busqueda);
            const n = Utils.normalizeText(ramo);
            const s = Utils.normalizeText(CurriculumData.ramos[ramo].sigla || '');
            if (!n.includes(b) && !s.includes(b)) return false;
          }
          
          // Filtro por disponibilidad
          if (this.state.mostrarSoloDisponibles) {
            if (!this.isApproved(ramo) && !this.estaDisponible(ramo)) return false;
          }
          
          return true;
        });
      
      if (!ramosSem.length) continue;
      
      const cont = document.createElement('div');
      cont.className = 'semestre';
      
      const title = document.createElement('h3');
      title.textContent = `${sem}Â° Semestre`;
      cont.appendChild(title);
      
      const innerFrag = document.createDocumentFragment();
      
      ramosSem.forEach(ramo => {
        const info = CurriculumData.ramos[ramo];
        const div = document.createElement('div');
        div.className = 'ramo';
        div.dataset.area = info.area;
        div.dataset.creditos = CurriculumData.creditosRamos[ramo] ?? '';
        div.setAttribute('role', 'listitem');
        div.tabIndex = 0;
        
        const contenido = document.createElement('div');
        const nombreEl = document.createElement('div');
        nombreEl.className = 'ramo-nombre';
        nombreEl.textContent = ramo;
        contenido.appendChild(nombreEl);
        
        const detalles = document.createElement('div');
        detalles.className = 'ramo-detalles';
        const siglaEl = document.createElement('span');
        siglaEl.className = 'ramo-sigla';
        siglaEl.textContent = info.sigla || 'SIGLA';
        const creditos = CurriculumData.creditosRamos[ramo];
        const creditosEl = document.createElement('span');
        creditosEl.className = 'ramo-creditos';
        creditosEl.textContent = `${creditos} crÃ©ditos`;
        detalles.appendChild(siglaEl);
        detalles.appendChild(creditosEl);
        contenido.appendChild(detalles);
        div.appendChild(contenido);
        
        const prere = this.prerequisitosDe(ramo);
        const desbloqueado = prere.every(p => this.isApproved(p));
        const estadoKey = `${sem}:${ramo}`;
        nuevoEstado.set(estadoKey, desbloqueado);
        
        // Tooltip mejorado
        const tooltipText = `ðŸ“š ${ramo}\nðŸ“‹ ${info.sigla} | ${creditos} crÃ©ditos\nðŸ·ï¸ ${info.area.charAt(0).toUpperCase() + info.area.slice(1)}\n\n${this.isApproved(ramo) ? 'âœ… Aprobado\nToca para desmarcar' : this.estaDisponible(ramo) ? 'ðŸŸ¡ Disponible\nToca para aprobar' : `ðŸ”’ Bloqueado\nRequiere: ${prere.filter(p => !this.isApproved(p)).join(', ') || 'Ninguno'}`}`;
        
        div.setAttribute('data-tooltip', tooltipText);
        
        // Aplicar clases segÃºn estado
        if (this.isApproved(ramo)) {
          div.classList.add('aprobado');
          div.onclick = () => this.toggleApproval(ramo);
          div.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.toggleApproval(ramo);
            }
          };
        } else if (this.estaDisponible(ramo)) {
          div.classList.add('disponible');
          if (!this.state.estadoAnterior.get(estadoKey)) {
            div.classList.add('desbloqueado');
            void div.offsetWidth; // Forzar reflow
          }
          div.onclick = () => this.toggleApproval(ramo);
          div.onkeydown = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.toggleApproval(ramo);
            }
          };
        } else {
          div.classList.add('bloqueado');
        }
        
        // Resaltado de prerrequisitos
        div.addEventListener('mouseenter', () => this.highlightPrereqs(ramo, true));
        div.addEventListener('mouseleave', () => this.highlightPrereqs(ramo, false));
        div.addEventListener('focus', () => this.highlightPrereqs(ramo, true));
        div.addEventListener('blur', () => this.highlightPrereqs(ramo, false));
        
        this.state.nombreToEl.set(ramo, div);
        innerFrag.appendChild(div);
      });
      
      cont.appendChild(innerFrag);
      frag.appendChild(cont);
      semestresRenderizados++;
    }
    
    // Actualizar DOM
    const malla = Utils.$('#malla');
    malla.innerHTML = '';
    malla.appendChild(frag);
    
    // Mostrar mensaje si no hay resultados
    if (semestresRenderizados === 0) {
      const noResults = document.createElement('div');
      noResults.className = 'no-results';
      noResults.innerHTML = `<ion-icon name="search-outline" style="font-size: 32px; margin-bottom: 8px;"></ion-icon><br>No se encontraron ramos que coincidan con la bÃºsqueda`;
      malla.appendChild(noResults);
    }
    
    this.state.estadoAnterior.clear();
    nuevoEstado.forEach((v, k) => this.state.estadoAnterior.set(k, v));
    
    requestAnimationFrame(() => this.syncBoxWidths());
  },
  
  // Configurar tooltips tÃ¡ctiles
  setupTouchTooltips() {
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    if (!isTouch) return;
    
    const tip = Utils.$('#touch-tip');
    const CONFIG = {
      tipMinW: 140,
      tipMaxW: null,
      tapMs: 140,
      moveHoverThrottleMs: 400,
      tipLongPress: false
    };
    
    let pressTimer = null;
    let pressTarget = null;
    let startX = 0, startY = 0;
    const MOVE_TOL = 12;
    const LONG_MS = 500;
    
    function showTipFor(target) {
      const txt = target.getAttribute('data-tooltip');
      if (!txt) return;
      
      const boxW = target.getBoundingClientRect().width;
      const maxFromCss = Utils.cssVarPx('--tip-max-w', 420);
      const maxPx = (CONFIG.tipMaxW ?? maxFromCss) || 420;
      const vwClamp = Math.max(0, window.innerWidth - 24);
      let w = Math.min(boxW, maxPx, vwClamp);
      w = Math.max(CONFIG.tipMinW, w);
      
      tip.style.width = Math.round(w) + 'px';
      tip.textContent = txt;
      tip.style.display = 'block';
      positionTip(target);
      
      clearTimeout(tip._hideT);
      tip._hideT = setTimeout(hideTip, 2500);
    }
    
    function hideTip() {
      tip.style.display = 'none';
      tip.textContent = '';
      tip.style.width = 'auto';
    }
    
    function positionTip(target) {
      const rect = target.getBoundingClientRect();
      const tipRect = tip.getBoundingClientRect();
      let x = rect.left + rect.width/2;
      let y = rect.top - 8;
      
      if (rect.top - tipRect.height - 16 < 0) {
        y = rect.bottom + tipRect.height/2 + 8;
        tip.style.transform = 'translate(-50%, -8px)';
      } else {
        tip.style.transform = 'translate(-50%, -8px)';
      }
      
      tip.style.left = x + 'px';
      tip.style.top = y + 'px';
    }
    
    function clearPress() {
      clearTimeout(pressTimer);
      pressTimer = null;
      pressTarget = null;
    }
    
    function onTouchStart(e) {
      const t = e.target.closest('.ramo');
      if (!t) return;
      
      pressTarget = t;
      const touch = e.changedTouches[0];
      startX = touch.clientX;
      startY = touch.clientY;
      
      clearPress();
      
      if (CONFIG.tipLongPress) {
        pressTimer = setTimeout(() => {
          showTipFor(t);
        }, LONG_MS);
      }
    }
    
    function onTouchMove(e) {
      if (!pressTimer) return;
      
      const touch = e.changedTouches[0];
      if (Math.abs(touch.clientX - startX) > MOVE_TOL || Math.abs(touch.clientY - startY) > MOVE_TOL) {
        clearPress();
      }
    }
    
    function onTouchEnd() {
      clearPress();
    }
    
    function onScrollOrOutsideTouch() {
      hideTip();
    }
    
    document.addEventListener('touchstart', onTouchStart, {passive: true});
    document.addEventListener('touchmove', onTouchMove, {passive: true});
    document.addEventListener('touchend', onTouchEnd, {passive: true});
    document.addEventListener('scroll', onScrollOrOutsideTouch, true);
  },
  
  // ACTUALIZADO: Configurar event listeners con nuevo selector
  setupEventListeners() {
    // NUEVO: Selector de semestre
    const semestreSelector = document.getElementById('select-semestre');
    if (semestreSelector) {
      semestreSelector.addEventListener('change', (e) => {
        this.guardarSemestreActual(e.target.value);
        NotificationManager.showToast(`Semestre actual actualizado a: ${e.target.value}Â°`, 'info');
      });
    }
    
    // Filtros de Ã¡rea
    Utils.$$('.area-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('active') && btn.dataset.area === this.state.areaSeleccionada) {
          btn.classList.remove('active');
          this.state.areaSeleccionada = 'none';
        } else {
          Utils.$$('.area-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          this.state.areaSeleccionada = btn.dataset.area;
        }
        this.render();
      });
    });
    
    // BÃºsqueda con debounce
    const searchInput = Utils.$('#search-input');
    const debouncedSearch = Utils.debounce((e) => {
      this.state.busqueda = e.target.value;
      this.render();
    }, 120);
    
    searchInput.addEventListener('input', debouncedSearch);
    
    // Toggle mostrar solo disponibles
    Utils.$('#toggle-disponibles').addEventListener('click', () => {
      this.state.mostrarSoloDisponibles = !this.state.mostrarSoloDisponibles;
      const boton = Utils.$('#toggle-disponibles');
      
      if (this.state.mostrarSoloDisponibles) {
        boton.classList.add('active');
        boton.innerHTML = '<ion-icon name="eye-off-outline"></ion-icon> Mostrar Todos';
      } else {
        boton.classList.remove('active');
        boton.innerHTML = '<ion-icon name="eye-outline"></ion-icon> Solo Disponibles';
      }
      
      this.render();
    });
    
    // BotÃ³n de reinicio
    Utils.$('#btn-reset').addEventListener('click', () => this.resetProgress());
    
    // BotÃ³n de exportaciÃ³n
    Utils.$('#export-data').addEventListener('click', () => this.exportData());
    
    // BotÃ³n de anÃ¡lisis de atraso
    Utils.$('#btn-analisis-atraso').addEventListener('click', () => {
      this.mostrarAnalisisAtraso();
    });

    // BotÃ³n para cerrar anÃ¡lisis
    Utils.$('#cerrar-analisis').addEventListener('click', () => {
      Utils.$('#atraso-container').style.display = 'none';
    });
  },
  
  // Configurar navegaciÃ³n por teclado
  setupKeyboardNavigation() {
    const isVisible = (el) => !!(el.offsetParent);
    const $ramos = () => Array.from(document.querySelectorAll('.ramo')).filter(isVisible);
    
    const center = (el) => {
      const r = el.getBoundingClientRect();
      return {x: r.left + r.width/2, y: r.top + r.height/2};
    };
    
    function pickInDirection(from, dir) {
      const origin = center(from);
      const candidates = $ramos().filter(el => !el.classList.contains('bloqueado') && el !== from);
      if (!candidates.length) return null;
      
      const weight = (dx, dy) => {
        if (dir === 'ArrowRight' && dx > 0) return dx*dx + (dy*dy)*0.7;
        if (dir === 'ArrowLeft'  && dx < 0) return dx*dx + (dy*dy)*0.7;
        if (dir === 'ArrowDown'  && dy > 0) return (dy*dy) + (dx*dx)*0.7;
        if (dir === 'ArrowUp'    && dy < 0) return (dy*dy) + (dx*dx)*0.7;
        return Infinity;
      };
      
      let best = null, bestScore = Infinity;
      for (const el of candidates) {
        const c = center(el);
        const dx = c.x - origin.x, dy = c.y - origin.y;
        const score = weight(dx, dy);
        if (score < bestScore) {
          bestScore = score;
          best = el;
        }
      }
      return isFinite(bestScore) ? best : null;
    }
    
    document.addEventListener('focusin', (ev) => {
      const el = ev.target;
      if (!(el instanceof HTMLElement)) return;
      if (!el.classList?.contains('ramo')) return;
      if (!el.classList.contains('bloqueado')) return;
      
      const next = pickInDirection(el, 'ArrowRight') ||
                  pickInDirection(el, 'ArrowDown') ||
                  pickInDirection(el, 'ArrowLeft') ||
                  pickInDirection(el, 'ArrowUp');
      
      if (next) {
        setTimeout(() => next.focus(), 0);
      }
    });
    
    document.addEventListener('keydown', (ev) => {
      const { key } = ev;
      const active = document.activeElement;
      const dentroDeRamo = active?.classList?.contains('ramo');
      
      if ((key === 'Enter' || key === ' ') && dentroDeRamo) {
        ev.preventDefault();
        active.click?.();
        return;
      }
      
      if (!['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(key)) return;
      
      if (!dentroDeRamo) {
        const primero = $ramos().find(el => !el.classList.contains('bloqueado'));
        if (primero) {
          primero.focus();
          ev.preventDefault();
        }
        return;
      }
      
      const next = pickInDirection(active, key);
      if (next) {
        next.focus();
        ev.preventDefault();
      }
    });
  }
};

// Inicializar la aplicaciÃ³n cuando el DOM estÃ© listo
document.addEventListener('DOMContentLoaded', () => {
  MallaApp.init();
});
</script>
</body>
</html>
